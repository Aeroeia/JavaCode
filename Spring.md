# 		Springé¢è¯•

## Spring

### è¯´ä¸€ä¸‹ä½ å¯¹ Spring çš„ç†è§£

![img](https://cdn.xiaolincoding.com//picgo/1712650311366-b499469c-5afd-4be9-bad3-d787de86bf98.png)

Springæ¡†æ¶æ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬ï¼š

- **IoCå®¹å™¨**ï¼šSpringé€šè¿‡æ§åˆ¶åè½¬å®ç°äº†å¯¹è±¡çš„åˆ›å»ºå’Œå¯¹è±¡é—´çš„ä¾èµ–å…³ç³»ç®¡ç†ã€‚å¼€å‘è€…åªéœ€è¦å®šä¹‰å¥½BeanåŠå…¶ä¾èµ–å…³ç³»ï¼ŒSpringå®¹å™¨è´Ÿè´£åˆ›å»ºå’Œç»„è£…è¿™äº›å¯¹è±¡ã€‚

  > æ§åˆ¶åè½¬çš„æ„æ€æ˜¯ï¼š
  >
  > - **åŸæœ¬ç”±ç¨‹åºå‘˜è‡ªå·±åœ¨ä»£ç ä¸­åˆ›å»ºå’Œç®¡ç†å¯¹è±¡çš„è¿‡ç¨‹**ï¼ˆæ¯”å¦‚ `new UserService()`ï¼‰ï¼Œ
  > - äº¤ç»™ **Spring å®¹å™¨** æ¥è´Ÿè´£å¯¹è±¡çš„åˆ›å»ºã€ç®¡ç†å’Œä¾èµ–æ³¨å…¥ã€‚

- **AOP**ï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œå…è®¸å¼€å‘è€…å®šä¹‰æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†ã€å®‰å…¨æ§åˆ¶ç­‰ï¼Œç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘çš„ä»£ç ã€‚é€šè¿‡AOPï¼Œå¯ä»¥å°†è¿™äº›å…³æ³¨ç‚¹æ¨¡å—åŒ–ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§ã€‚

- **äº‹åŠ¡ç®¡ç†**ï¼šSpringæä¾›äº†ä¸€è‡´çš„äº‹åŠ¡ç®¡ç†æ¥å£ï¼Œæ”¯æŒå£°æ˜å¼å’Œç¼–ç¨‹å¼äº‹åŠ¡ã€‚å¼€å‘è€…å¯ä»¥è½»æ¾åœ°è¿›è¡Œäº‹åŠ¡ç®¡ç†ï¼Œè€Œæ— éœ€å…³å¿ƒå…·ä½“çš„äº‹åŠ¡APIã€‚

- **MVCæ¡†æ¶**ï¼šSpring MVCæ˜¯ä¸€ä¸ªåŸºäºServlet APIæ„å»ºçš„Webæ¡†æ¶ï¼Œé‡‡ç”¨äº†æ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨ï¼ˆMVCï¼‰æ¶æ„ã€‚å®ƒæ”¯æŒçµæ´»çš„URLåˆ°é¡µé¢æ§åˆ¶å™¨çš„æ˜ å°„ï¼Œä»¥åŠå¤šç§è§†å›¾æŠ€æœ¯ã€‚

------

### Springçš„aopä»‹ç»ä¸€ä¸‹

Spring AOPæ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦æ¨¡å—ï¼Œç”¨äºå®ç°é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚

æˆ‘ä»¬çŸ¥é“ï¼ŒJava å°±æ˜¯ä¸€é—¨é¢å‘å¯¹è±¡ç¼–ç¨‹çš„è¯­è¨€ï¼Œåœ¨ OOP ä¸­æœ€å°çš„å•å…ƒå°±æ˜¯â€œClass å¯¹è±¡â€ï¼Œä½†æ˜¯åœ¨ AOP ä¸­æœ€å°çš„å•å…ƒæ˜¯â€œåˆ‡é¢â€ã€‚ä¸€ä¸ªâ€œåˆ‡é¢â€å¯ä»¥åŒ…å«å¾ˆå¤šç§ç±»å‹å’Œå¯¹è±¡ï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ¨¡å—åŒ–ç®¡ç†ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†ã€‚

åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹çš„æ€æƒ³é‡Œé¢ï¼ŒæŠŠåŠŸèƒ½åˆ†ä¸ºä¸¤ç§

- **æ ¸å¿ƒä¸šåŠ¡**ï¼šç™»é™†ã€æ³¨å†Œã€å¢ã€åˆ ã€æ”¹ã€æŸ¥ã€éƒ½å«æ ¸å¿ƒä¸šåŠ¡
- **å‘¨è¾¹åŠŸèƒ½**ï¼šæ—¥å¿—ã€äº‹åŠ¡ç®¡ç†è¿™äº›æ¬¡è¦çš„ä¸ºå‘¨è¾¹ä¸šåŠ¡

åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹ä¸­ï¼Œæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½å’Œå‘¨è¾¹åŠŸèƒ½æ˜¯åˆ†åˆ«ç‹¬ç«‹è¿›è¡Œå¼€å‘ï¼Œä¸¤è€…ä¸æ˜¯è€¦åˆçš„ï¼Œç„¶åæŠŠåˆ‡é¢åŠŸèƒ½å’Œæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ "ç¼–ç»‡" åœ¨ä¸€èµ·ï¼Œè¿™å°±å«AOPã€‚

AOPèƒ½å¤Ÿå°†é‚£äº›ä¸ä¸šåŠ¡æ— å…³ï¼Œ**å´ä¸ºä¸šåŠ¡æ¨¡å—æ‰€å…±åŒè°ƒç”¨çš„é€»è¾‘æˆ–è´£ä»»ï¼ˆä¾‹å¦‚äº‹åŠ¡å¤„ç†ã€æ—¥å¿—ç®¡ç†ã€æƒé™æ§åˆ¶ç­‰ï¼‰å°è£…èµ·æ¥**ï¼Œä¾¿äº**å‡å°‘ç³»ç»Ÿçš„é‡å¤ä»£ç **ï¼Œ**é™ä½æ¨¡å—é—´çš„è€¦åˆåº¦**ï¼Œå¹¶**æœ‰åˆ©äºæœªæ¥çš„å¯æ‹“å±•æ€§å’Œå¯ç»´æŠ¤æ€§**ã€‚

åœ¨ AOP ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š

- **AspectJ**ï¼šåˆ‡é¢ï¼Œåªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œæ²¡æœ‰å…·ä½“çš„æ¥å£æˆ–ç±»ä¸ä¹‹å¯¹åº”ï¼Œæ˜¯ Join pointï¼ŒAdvice å’Œ Pointcut çš„ä¸€ä¸ªç»Ÿç§°ã€‚
- **Join point**ï¼šè¿æ¥ç‚¹ï¼ŒæŒ‡ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œä¾‹å¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸å¤„ç†ç­‰ã€‚==åœ¨ Spring AOP ä¸­ï¼Œä»…æ”¯æŒæ–¹æ³•çº§åˆ«çš„è¿æ¥ç‚¹ã€‚==
- **Advice**ï¼šé€šçŸ¥ï¼Œå³æˆ‘ä»¬å®šä¹‰çš„ä¸€ä¸ªåˆ‡é¢ä¸­çš„æ¨ªåˆ‡é€»è¾‘ï¼Œ==æœ‰â€œaroundâ€ï¼Œâ€œbeforeâ€å’Œâ€œafterâ€ä¸‰ç§ç±»å‹==ã€‚åœ¨å¾ˆå¤šçš„ AOP å®ç°æ¡†æ¶ä¸­ï¼ŒAdvice é€šå¸¸ä½œä¸ºä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œä¹Ÿå¯ä»¥åŒ…å«è®¸å¤šä¸ªæ‹¦æˆªå™¨ä½œä¸ºä¸€æ¡é“¾è·¯å›´ç»•ç€ Join point è¿›è¡Œå¤„ç†ã€‚
- **Pointcut**ï¼šåˆ‡ç‚¹ï¼Œç”¨äºåŒ¹é…è¿æ¥ç‚¹ï¼Œä¸€ä¸ª AspectJ ä¸­åŒ…å«å“ªäº› Join point éœ€è¦ç”± Pointcut è¿›è¡Œç­›é€‰ã€‚
- **Introduction**ï¼šå¼•ä»‹ï¼Œè®©ä¸€ä¸ªåˆ‡é¢å¯ä»¥å£°æ˜è¢«é€šçŸ¥çš„å¯¹è±¡å®ç°ä»»ä½•ä»–ä»¬æ²¡æœ‰çœŸæ­£å®ç°çš„é¢å¤–çš„æ¥å£ã€‚ä¾‹å¦‚å¯ä»¥è®©ä¸€ä¸ªä»£ç†å¯¹è±¡ä»£ç†ä¸¤ä¸ªç›®æ ‡ç±»ã€‚
- **Weaving**ï¼šç»‡å…¥ï¼Œåœ¨æœ‰äº†è¿æ¥ç‚¹ã€åˆ‡ç‚¹ã€é€šçŸ¥ä»¥åŠåˆ‡é¢ï¼Œå¦‚ä½•å°†å®ƒä»¬åº”ç”¨åˆ°ç¨‹åºä¸­å‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯ç»‡å…¥ï¼Œåœ¨åˆ‡ç‚¹çš„å¼•å¯¼ä¸‹ï¼Œå°†é€šçŸ¥é€»è¾‘æ’å…¥åˆ°ç›®æ ‡æ–¹æ³•ä¸Šï¼Œä½¿å¾—æˆ‘ä»¬çš„é€šçŸ¥é€»è¾‘åœ¨æ–¹æ³•è°ƒç”¨æ—¶å¾—ä»¥æ‰§è¡Œã€‚
- **AOP proxy**ï¼šAOP ä»£ç†ï¼ŒæŒ‡åœ¨ AOP å®ç°æ¡†æ¶ä¸­å®ç°åˆ‡é¢åè®®çš„å¯¹è±¡ã€‚åœ¨ Spring AOP ä¸­æœ‰ä¸¤ç§ä»£ç†ï¼Œåˆ†åˆ«æ˜¯ JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç†ã€‚
- **Target object**ï¼šç›®æ ‡å¯¹è±¡ï¼Œå°±æ˜¯è¢«ä»£ç†çš„å¯¹è±¡ã€‚

Spring AOP æ˜¯==åŸºäº JDK åŠ¨æ€ä»£ç†å’Œ Cglib æå‡å®ç°çš„==ï¼Œä¸¤ç§ä»£ç†æ–¹å¼éƒ½å±äºè¿è¡Œæ—¶çš„ä¸€ä¸ªæ–¹å¼ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰ç¼–è¯‘æ—¶çš„ä¸€ä¸ªå¤„ç†ï¼Œé‚£ä¹ˆå› æ­¤ Spring æ˜¯é€šè¿‡ Java ä»£ç å®ç°çš„ã€‚

==Spring AOP åŸºäº**åŠ¨æ€ä»£ç†**ï¼ˆJDK åŠ¨æ€ä»£ç†æˆ– CGLIBï¼‰ï¼Œå®ƒåªä¼šä»£ç†ç”± **Spring IoC å®¹å™¨åˆ›å»ºå’Œç®¡ç†çš„ Bean**==

------

### IOCå’ŒAOPæ˜¯é€šè¿‡ä»€ä¹ˆæœºåˆ¶æ¥å®ç°çš„?

> Spring IOC å®ç°æœºåˆ¶

- **åå°„**ï¼šSpring IOCå®¹å™¨åˆ©ç”¨Javaçš„åå°„æœºåˆ¶åŠ¨æ€åœ°åŠ è½½ç±»ã€åˆ›å»ºå¯¹è±¡å®ä¾‹åŠè°ƒç”¨å¯¹è±¡æ–¹æ³•ï¼Œåå°„å…è®¸åœ¨è¿è¡Œæ—¶æ£€æŸ¥ç±»ã€æ–¹æ³•ã€å±æ€§ç­‰ä¿¡æ¯ï¼Œä»è€Œå®ç°çµæ´»çš„å¯¹è±¡å®ä¾‹åŒ–å’Œç®¡ç†ã€‚
- **ä¾èµ–æ³¨å…¥**ï¼šIOCçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ä¾èµ–æ³¨å…¥ï¼Œå³å®¹å™¨è´Ÿè´£ç®¡ç†åº”ç”¨ç¨‹åºç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚Springé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ã€å±æ€§æ³¨å…¥æˆ–æ–¹æ³•æ³¨å…¥ï¼Œå°†ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»æè¿°åœ¨é…ç½®æ–‡ä»¶ä¸­æˆ–ä½¿ç”¨æ³¨è§£ã€‚
- **è®¾è®¡æ¨¡å¼ - å·¥å‚æ¨¡å¼**ï¼šSpring IOCå®¹å™¨é€šå¸¸é‡‡ç”¨å·¥å‚æ¨¡å¼æ¥ç®¡ç†å¯¹è±¡çš„åˆ›å»ºå’Œç”Ÿå‘½å‘¨æœŸã€‚å®¹å™¨ä½œä¸ºå·¥å‚è´Ÿè´£å®ä¾‹åŒ–Beanå¹¶ç®¡ç†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°†Beançš„å®ä¾‹åŒ–è¿‡ç¨‹äº¤ç»™å®¹å™¨æ¥ç®¡ç†ã€‚
- **å®¹å™¨å®ç°**ï¼šSpring IOCå®¹å™¨æ˜¯å®ç°IOCçš„æ ¸å¿ƒï¼Œé€šå¸¸ä½¿ç”¨BeanFactoryæˆ–ApplicationContextæ¥ç®¡ç†Beanã€‚BeanFactoryæ˜¯IOCå®¹å™¨çš„åŸºæœ¬å½¢å¼ï¼Œæä¾›åŸºæœ¬çš„IOCåŠŸèƒ½ï¼›ApplicationContextæ˜¯BeanFactoryçš„æ‰©å±•ï¼Œå¹¶æä¾›æ›´å¤šä¼ä¸šçº§åŠŸèƒ½ã€‚

> Spring AOP å®ç°æœºåˆ¶

Spring AOPçš„å®ç°ä¾èµ–äº**åŠ¨æ€ä»£ç†æŠ€æœ¯**ã€‚åŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶ã€‚å®ƒå…è®¸å¼€å‘è€…åœ¨è¿è¡Œæ—¶æŒ‡å®šè¦ä»£ç†çš„æ¥å£å’Œè¡Œä¸ºï¼Œä»è€Œå®ç°åœ¨ä¸ä¿®æ”¹æºç çš„æƒ…å†µä¸‹å¢å¼ºæ–¹æ³•çš„åŠŸèƒ½ã€‚

Spring AOPæ”¯æŒä¸¤ç§åŠ¨æ€ä»£ç†ï¼š

- **åŸºäºJDKçš„åŠ¨æ€ä»£ç†**ï¼šä½¿ç”¨java.lang.reflect.Proxyç±»å’Œjava.lang.reflect.InvocationHandleræ¥å£å®ç°ã€‚è¿™ç§æ–¹å¼éœ€è¦ä»£ç†çš„ç±»å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ã€‚
- **åŸºäºCGLIBçš„åŠ¨æ€ä»£ç†**ï¼šå½“è¢«ä»£ç†çš„ç±»æ²¡æœ‰å®ç°æ¥å£æ—¶ï¼ŒSpringä¼šä½¿ç”¨CGLIBåº“ç”Ÿæˆä¸€ä¸ªè¢«ä»£ç†ç±»çš„å­ç±»ä½œä¸ºä»£ç†ã€‚CGLIBï¼ˆCode Generation Libraryï¼‰æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹ä»£ç ç”Ÿæˆåº“ï¼Œé€šè¿‡ç»§æ‰¿æ–¹å¼å®ç°ä»£ç†ã€‚

==jdkåŠ¨æ€ä»£ç†æ˜¯å°†æ¥å£æ–¹æ³•å®ç° åœ¨é‡Œé¢å†™è‡ªå®šä¹‰é€»è¾‘ç„¶åè°ƒç”¨å®ç°ç±»æ–¹æ³• ç„¶åcglibæ˜¯ç»§æ‰¿å®ç°ç±» ç„¶åè‡ªå®šä¹‰é€»è¾‘ä¸­è°ƒç”¨å®ç°ç±»æ–¹æ³•==

------

### æ€ä¹ˆç†è§£SpringIocï¼Ÿ

**IOC**ï¼šInversion Of Controlï¼Œå³æ§åˆ¶åè½¬ï¼Œæ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚åœ¨ä¼ ç»Ÿçš„ Java SE ç¨‹åºè®¾è®¡ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨é€šè¿‡ new çš„æ–¹å¼æ¥åˆ›å»ºå¯¹è±¡ï¼Œæ˜¯ç¨‹åºä¸»åŠ¨åˆ›å»ºä¾èµ–å¯¹è±¡ï¼›

![img](https://cdn.xiaolincoding.com//picgo/1716790809843-e520e960-fb95-4511-aa30-73966361320a.webp)

è€Œåœ¨Springç¨‹åºè®¾è®¡ä¸­ï¼ŒIOC æ˜¯æœ‰ä¸“é—¨çš„å®¹å™¨å»æ§åˆ¶å¯¹è±¡ã€‚

![img](https://cdn.xiaolincoding.com//picgo/1716790809860-74256f8b-3a96-485c-8aa1-11fa5dfb7640.webp)

**æ‰€è°“æ§åˆ¶**å°±æ˜¯å¯¹è±¡çš„åˆ›å»ºã€åˆå§‹åŒ–ã€é”€æ¯ã€‚

- åˆ›å»ºå¯¹è±¡ï¼šåŸæ¥æ˜¯ new ä¸€ä¸ªï¼Œç°åœ¨æ˜¯ç”± Spring å®¹å™¨åˆ›å»ºã€‚
- åˆå§‹åŒ–å¯¹è±¡ï¼šåŸæ¥æ˜¯å¯¹è±¡è‡ªå·±é€šè¿‡æ„é€ å™¨æˆ–è€… setter æ–¹æ³•ç»™ä¾èµ–çš„å¯¹è±¡èµ‹å€¼ï¼Œç°åœ¨æ˜¯ç”± Spring å®¹å™¨è‡ªåŠ¨æ³¨å…¥ã€‚
- é”€æ¯å¯¹è±¡ï¼šåŸæ¥æ˜¯ç›´æ¥ç»™å¯¹è±¡èµ‹å€¼ null æˆ–åšä¸€äº›é”€æ¯æ“ä½œï¼Œç°åœ¨æ˜¯ Spring å®¹å™¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸè´Ÿè´£é”€æ¯å¯¹è±¡ã€‚

æ€»ç»“ï¼šIOC è§£å†³äº†ç¹ççš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„æ“ä½œï¼Œè§£è€¦äº†æˆ‘ä»¬çš„ä»£ç ã€‚**æ‰€è°“åè½¬**ï¼šå…¶å®æ˜¯åè½¬çš„æ§åˆ¶æƒï¼Œå‰é¢æåˆ°æ˜¯ç”± Spring æ¥æ§åˆ¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆå¯¹è±¡çš„æ§åˆ¶å°±å®Œå…¨è„±ç¦»äº†æˆ‘ä»¬çš„æ§åˆ¶ï¼Œæ§åˆ¶æƒäº¤ç»™äº† Spring ã€‚è¿™ä¸ªåè½¬æ˜¯æŒ‡ï¼š==æˆ‘ä»¬ç”±å¯¹è±¡çš„æ§åˆ¶è€…å˜æˆäº† IOC çš„è¢«åŠ¨æ§åˆ¶è€…ã€‚==

### ä¾èµ–å€’ç½®ï¼Œä¾èµ–æ³¨å…¥ï¼Œæ§åˆ¶åè½¬åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- æ§åˆ¶åè½¬ï¼šâ€œæ§åˆ¶â€æŒ‡çš„æ˜¯å¯¹ç¨‹åºæ‰§è¡Œæµç¨‹çš„æ§åˆ¶ï¼Œè€Œâ€œåè½¬â€æŒ‡çš„æ˜¯åœ¨æ²¡æœ‰ä½¿ç”¨æ¡†æ¶ä¹‹å‰ï¼Œç¨‹åºå‘˜è‡ªå·±æ§åˆ¶æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œã€‚åœ¨ä½¿ç”¨æ¡†æ¶ä¹‹åï¼Œæ•´ä¸ªç¨‹åºçš„æ‰§è¡Œæµç¨‹é€šè¿‡æ¡†æ¶æ¥æ§åˆ¶ã€‚æµç¨‹çš„æ§åˆ¶æƒä»ç¨‹åºå‘˜â€œåè½¬â€ç»™äº†æ¡†æ¶ã€‚

- ä¾èµ–æ³¨å…¥ï¼šä¾èµ–æ³¨å…¥å’Œæ§åˆ¶åè½¬æ°æ°ç›¸åï¼Œå®ƒæ˜¯ä¸€ç§å…·ä½“çš„ç¼–ç æŠ€å·§ã€‚æˆ‘ä»¬ä¸é€šè¿‡ new çš„æ–¹å¼åœ¨ç±»å†…éƒ¨åˆ›å»ºä¾èµ–ç±»çš„å¯¹è±¡ï¼Œè€Œæ˜¯å°†ä¾èµ–çš„ç±»å¯¹è±¡åœ¨å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åï¼Œé€šè¿‡æ„é€ å‡½æ•°ã€å‡½æ•°å‚æ•°ç­‰æ–¹å¼ä¼ é€’ï¼ˆæˆ–æ³¨å…¥ï¼‰ç»™ç±»æ¥ä½¿ç”¨ã€‚

- ä¾èµ–å€’ç½®ï¼šè¿™æ¡åŸåˆ™è·Ÿæ§åˆ¶åè½¬æœ‰ç‚¹ç±»ä¼¼ï¼Œä¸»è¦ç”¨æ¥æŒ‡å¯¼æ¡†æ¶å±‚é¢çš„è®¾è®¡ã€‚é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œå®ƒä»¬å…±åŒä¾èµ–åŒä¸€ä¸ªæŠ½è±¡ã€‚æŠ½è±¡ä¸è¦ä¾èµ–å…·ä½“å®ç°ç»†èŠ‚ï¼Œå…·ä½“å®ç°ç»†èŠ‚ä¾èµ–æŠ½è±¡ã€‚

  **ä¼ ç»Ÿä¾èµ–**

  ```java
  // é«˜å±‚æ¨¡å—ï¼šä¸šåŠ¡é€»è¾‘å±‚
  public class OrderService {
      // ç›´æ¥ä¾èµ–ä½å±‚æ¨¡å—ï¼ˆå…·ä½“å®ç°ï¼‰
      private MySQLOrderRepository orderRepository = new MySQLOrderRepository();
      
      public void createOrder() {
          orderRepository.saveOrder();
      }
  }
  
  // ä½å±‚æ¨¡å—ï¼šæ•°æ®è®¿é—®å±‚
  public class MySQLOrderRepository {
      public void saveOrder() {
          // å…·ä½“å®ç°ï¼šMySQL ä¿å­˜è®¢å•
      }
  }
  ```

  **ä¾èµ–å€’ç½®**

  ```java
  // 1. å®šä¹‰æŠ½è±¡ï¼ˆæ¥å£ï¼‰
  public interface OrderRepository {
      void saveOrder();
  }
  
  // 2. é«˜å±‚æ¨¡å—ä¾èµ–æŠ½è±¡
  public class OrderService {
      // ä¾èµ–æŠ½è±¡ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°
      private final OrderRepository orderRepository;
      
      public OrderService(OrderRepository orderRepository) {
          this.orderRepository = orderRepository;
      }
      
      public void createOrder() {
          orderRepository.saveOrder();
      }
  }
  
  // 3. ä½å±‚æ¨¡å—å®ç°æŠ½è±¡
  public class MySQLOrderRepository implements OrderRepository {
      @Override
      public void saveOrder() {
          // MySQL å®ç°
      }
  }
  
  public class MongoDBOrderRepository implements OrderRepository {
      @Override
      public void saveOrder() {
          // MongoDB å®ç°
      }
  }
  ```

------

### ä¾èµ–æ³¨å…¥äº†è§£å—ï¼Ÿæ€ä¹ˆå®ç°ä¾èµ–æ³¨å…¥çš„ï¼Ÿ

åœ¨ä¼ ç»Ÿç¼–ç¨‹ä¸­ï¼Œå½“ä¸€ä¸ªç±»éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªç±»çš„å¯¹è±¡æ—¶ï¼Œé€šå¸¸ä¼šåœ¨è¯¥ç±»å†…éƒ¨é€šè¿‡`new`å…³é”®å­—æ¥åˆ›å»ºä¾èµ–å¯¹è±¡ï¼Œè¿™ä½¿å¾—ç±»ä¸ç±»ä¹‹é—´çš„è€¦åˆåº¦è¾ƒé«˜ã€‚

è€Œä¾èµ–æ³¨å…¥åˆ™æ˜¯å°†å¯¹è±¡çš„åˆ›å»ºå’Œä¾èµ–å…³ç³»çš„ç®¡ç†äº¤ç»™ Spring å®¹å™¨æ¥å®Œæˆï¼Œç±»åªéœ€è¦å£°æ˜è‡ªå·±æ‰€ä¾èµ–çš„å¯¹è±¡ï¼Œå®¹å™¨ä¼šåœ¨è¿è¡Œæ—¶å°†è¿™äº›ä¾èµ–å¯¹è±¡æ³¨å…¥åˆ°ç±»ä¸­ï¼Œä»è€Œé™ä½äº†ç±»ä¸ç±»ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

å…·ä½“åˆ°Springä¸­ï¼Œå¸¸è§çš„ä¾èµ–æ³¨å…¥çš„å®ç°æ–¹å¼ï¼Œæ¯”å¦‚æ„é€ å™¨æ³¨å…¥ã€Setteræ–¹æ³•æ³¨å…¥ï¼Œè¿˜æœ‰å­—æ®µæ³¨å…¥ã€‚

- **æ„é€ å™¨æ³¨å…¥ï¼š**é€šè¿‡æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–å¯¹è±¡ï¼Œä¿è¯å¯¹è±¡åˆå§‹åŒ–æ—¶ä¾èµ–å·²å°±ç»ªã€‚

```java
@Service
public class UserService {
    private final UserRepository userRepository;
    
    // æ„é€ å™¨æ³¨å…¥ï¼ˆSpring 4.3+ è‡ªåŠ¨è¯†åˆ«å•æ„é€ å™¨ï¼Œæ— éœ€æ˜¾å¼@Autowiredï¼‰
    public UserService(UserRepository userRepository) {
        this.userRepository = userRepository;
    }
}
```

- **Setter æ–¹æ³•æ³¨å…¥ï¼š**é€šè¿‡ Setter æ–¹æ³•è®¾ç½®ä¾èµ–ï¼Œçµæ´»æ€§é«˜ï¼Œä½†ä¾èµ–å¯èƒ½æœªå®Œå…¨åˆå§‹åŒ–ã€‚

```java
public class PaymentService {
    private PaymentGateway gateway;
    
    @Autowired
    public void setGateway(PaymentGateway gateway) {
        this.gateway = gateway;
    }
}
```

- **å­—æ®µæ³¨å…¥ï¼š**ç›´æ¥é€šè¿‡ `@Autowired` æ³¨è§£å­—æ®µï¼Œä»£ç ç®€æ´ä½†éšè—ä¾èµ–å…³ç³»ï¼Œä¸æ¨èç”Ÿäº§ä»£ç ã€‚

```java
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
}
```

------

### å¦‚æœè®©ä½ è®¾è®¡ä¸€ä¸ªSpringIocï¼Œä½ è§‰å¾—ä¼šä»å“ªäº›æ–¹é¢è€ƒè™‘è¿™ä¸ªè®¾è®¡ï¼Ÿ

- Beançš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šéœ€è¦è®¾è®¡Beançš„åˆ›å»ºã€åˆå§‹åŒ–ã€é”€æ¯ç­‰ç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨==å·¥å‚æ¨¡å¼å’Œå•ä¾‹æ¨¡å¼==æ¥å®ç°ã€‚

- ä¾èµ–æ³¨å…¥ï¼šéœ€è¦å®ç°ä¾èµ–æ³¨å…¥çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å±æ€§æ³¨å…¥ã€æ„é€ å‡½æ•°æ³¨å…¥ã€æ–¹æ³•æ³¨å…¥ç­‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨==åå°„æœºåˆ¶å’ŒXMLé…ç½®æ–‡ä»¶==æ¥å®ç°ã€‚

- Beançš„ä½œç”¨åŸŸï¼šéœ€è¦æ”¯æŒå¤šç§Beanä½œç”¨åŸŸï¼Œæ¯”å¦‚å•ä¾‹ã€åŸå‹ã€ä¼šè¯ã€è¯·æ±‚ç­‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨Mapæ¥å­˜å‚¨ä¸åŒä½œç”¨åŸŸçš„Beanå®ä¾‹ã€‚

  > #### â‘  Singletonï¼ˆå•ä¾‹ä½œç”¨åŸŸï¼‰ - **é»˜è®¤ä½œç”¨åŸŸ**
  >
  > - âˆ™**å«ä¹‰**ï¼šåœ¨æ•´ä¸ª Spring IoC å®¹å™¨ä¸­ï¼Œ**åªå­˜åœ¨ä¸€ä¸ª**è¯¥ Bean çš„å…±äº«å®ä¾‹ã€‚
  > - âˆ™**ç”Ÿå‘½å‘¨æœŸ**ï¼šâˆ™**åˆ›å»º**ï¼šå®¹å™¨å¯åŠ¨æ—¶ï¼ˆå¦‚æœè®¾ç½®ä¸ºæ‡’åŠ è½½åˆ™æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼‰åˆ›å»ºã€‚âˆ™**é”€æ¯**ï¼šå®¹å™¨å…³é—­æ—¶é”€æ¯ã€‚
  > - âˆ™**ç±»æ¯”**ï¼šå…¬å¸é‡Œçš„**æ‰“å°æœº**ã€‚å…¨å…¬å¸åªæœ‰è¿™ä¸€å°ï¼Œæ‰€æœ‰äººï¼ˆæ‰€æœ‰ä»£ç ã€æ‰€æœ‰è¯·æ±‚ï¼‰éƒ½å…±äº«ä½¿ç”¨è¿™ä¸€å°ã€‚èŠ‚çœèµ„æºï¼Œä½†è¦ç‰¹åˆ«æ³¨æ„çº¿ç¨‹å®‰å…¨ï¼ˆä¸èƒ½ä¸¤ä¸ªäººåŒæ—¶è®¾ç½®ä¸åŒçš„æ‰“å°è®¾ç½®ï¼‰ã€‚
  > - âˆ™**ä»£ç **ï¼š`@Scope("singleton")`æˆ– `@Scope(ConfigurableBeanFactory.SCOPE_SINGLETON)`ï¼Œæˆ–è€…ä¸å†™ï¼ˆå› ä¸ºå®ƒæ˜¯é»˜è®¤å€¼ï¼‰ã€‚
  >
  > #### â‘¡ Prototypeï¼ˆåŸå‹ä½œç”¨åŸŸï¼‰
  >
  > - âˆ™**å«ä¹‰**ï¼š**æ¯æ¬¡è¯·æ±‚**ï¼ˆé€šè¿‡ `getBean()`æˆ–æ³¨å…¥ï¼‰éƒ½ä¼šåˆ›å»ºä¸€ä¸ª**å…¨æ–°çš„** Bean å®ä¾‹ã€‚
  > - âˆ™**ç”Ÿå‘½å‘¨æœŸ**ï¼šâˆ™**åˆ›å»º**ï¼šæ¯æ¬¡è¢«è¯·æ±‚æ—¶åˆ›å»ºã€‚âˆ™**é”€æ¯**ï¼šåˆ›å»ºåï¼Œå®ä¾‹çš„ç®¡ç†æƒå°±äº¤ç»™äº†å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨å®ƒçš„ä»£ç ï¼‰ï¼Œå®¹å™¨ä¸å†è·Ÿè¸ªå…¶ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿä¸ä¼šè´Ÿè´£é”€æ¯å®ƒã€‚ç±»ä¼¼äº Java çš„ `new`å…³é”®å­—ã€‚
  > - âˆ™**ç±»æ¯”**ï¼šåŒ»é™¢æ‰“é’ˆç”¨çš„**ä¸€æ¬¡æ€§æ³¨å°„å™¨**ã€‚æ¯æ¬¡éœ€è¦æ‰“é’ˆï¼ˆæ¯æ¬¡è¯·æ±‚ï¼‰æ—¶ï¼ŒæŠ¤å£«éƒ½ä¼šç»™ä½ æ‹¿ä¸€ä¸ªå…¨æ–°çš„ã€ç‹¬ç«‹çš„æ³¨å°„å™¨ã€‚ç”¨å®Œå³å¼ƒã€‚
  > - âˆ™**ä»£ç **ï¼š`@Scope("prototype")`æˆ– `@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)`
  >
  > #### â‘¢ Requestï¼ˆè¯·æ±‚ä½œç”¨åŸŸï¼‰ - **Web åº”ç”¨ç‰¹æœ‰**
  >
  > - âˆ™**å«ä¹‰**ï¼šåœ¨ä¸€æ¬¡ HTTP è¯·æ±‚ä¸­ï¼Œåªåˆ›å»ºä¸€ä¸ª Bean å®ä¾‹ã€‚ä¸åŒçš„ HTTP è¯·æ±‚ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ Bean å®ä¾‹ï¼Œå®ƒä»¬ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚
  > - âˆ™**ç”Ÿå‘½å‘¨æœŸ**ï¼šâˆ™**åˆ›å»º**ï¼šæ¯æ¬¡ HTTP è¯·æ±‚å¼€å§‹æ—¶åˆ›å»ºã€‚âˆ™**é”€æ¯**ï¼šæœ¬æ¬¡ HTTP è¯·æ±‚ç»“æŸæ—¶é”€æ¯ã€‚
  > - âˆ™**é€‚ç”¨åœºæ™¯**ï¼šéå¸¸é€‚åˆç”¨æ¥å­˜å‚¨ä¸å½“å‰è¯·æ±‚ç›¸å…³çš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·çš„è¡¨å•æ•°æ®ã€è¯·æ±‚å‚æ•°ç­‰ã€‚
  > - âˆ™**ä»£ç **ï¼š`@Scope("request")`æˆ– `@Scope(WebApplicationContext.SCOPE_REQUEST)`
  > - âˆ™**å‰æ**ï¼šå¿…é¡»åœ¨ Web ç¯å¢ƒçš„ Spring åº”ç”¨ä¸­ï¼ˆå¦‚ Spring MVCï¼‰æ‰èƒ½ä½¿ç”¨ã€‚
  >
  > #### â‘£ Sessionï¼ˆä¼šè¯ä½œç”¨åŸŸï¼‰ - **Web åº”ç”¨ç‰¹æœ‰**
  >
  > - âˆ™**å«ä¹‰**ï¼šåœ¨ä¸€ä¸ª HTTP Session ä¸­ï¼Œåªåˆ›å»ºä¸€ä¸ª Bean å®ä¾‹ã€‚åŒä¸€ä¸ªç”¨æˆ·ï¼ˆåŒä¸€ä¸ª Sessionï¼‰çš„å¤šæ¬¡è¯·æ±‚ä¼šå…±äº«è¿™ä¸ª Beanï¼Œä¸åŒç”¨æˆ·çš„ Session æ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„ Beanã€‚
  > - âˆ™**ç”Ÿå‘½å‘¨æœŸ**ï¼šâˆ™**åˆ›å»º**ï¼šç¬¬ä¸€æ¬¡æœ‰è¯·æ±‚æ¥è‡ªæŸä¸ª Session æ—¶åˆ›å»ºã€‚âˆ™**é”€æ¯**ï¼šè¯¥ HTTP Session è¶…æ—¶æˆ–å¤±æ•ˆæ—¶é”€æ¯ã€‚
  > - âˆ™**é€‚ç”¨åœºæ™¯**ï¼šå­˜å‚¨ç”¨æˆ·çº§åˆ«çš„ä¿¡æ¯ï¼Œæœ€å…¸å‹çš„å°±æ˜¯**ç”¨æˆ·ç™»å½•çŠ¶æ€**ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ï¼ˆç”¨æˆ·åã€IDç­‰ï¼‰æ”¾å…¥ä¸€ä¸ª Session ä½œç”¨åŸŸçš„ Bean ä¸­ï¼Œåœ¨æ•´ä¸ªä¼šè¯æœŸé—´éƒ½å¯ä»¥æ–¹ä¾¿åœ°è·å–ã€‚
  > - âˆ™**ä»£ç **ï¼š`@Scope("session")`æˆ– `@Scope(WebApplicationContext.SCOPE_SESSION)`
  > - âˆ™**å‰æ**ï¼šåŒæ ·ï¼Œå¿…é¡»åœ¨ Web ç¯å¢ƒçš„ Spring åº”ç”¨ä¸­æ‰èƒ½ä½¿ç”¨ã€‚

- AOPåŠŸèƒ½çš„æ”¯æŒï¼šéœ€è¦æ”¯æŒAOPåŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘==ä½¿ç”¨åŠ¨æ€ä»£ç†æœºåˆ¶å’Œåˆ‡é¢ç¼–ç¨‹==æ¥å®ç°ã€‚

- å¼‚å¸¸å¤„ç†ï¼šéœ€è¦è€ƒè™‘å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬==Beanåˆ›å»ºå¼‚å¸¸ã€ä¾èµ–æ³¨å…¥å¼‚å¸¸==ç­‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨try-catchæœºåˆ¶æ¥å¤„ç†å¼‚å¸¸ã€‚

- é…ç½®æ–‡ä»¶åŠ è½½ï¼šéœ€è¦æ”¯æŒ==ä»ä¸åŒçš„é…ç½®æ–‡ä»¶ä¸­åŠ è½½Beançš„ç›¸å…³ä¿¡æ¯==ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨XMLã€æ³¨è§£æˆ–è€…Javaé…ç½®ç±»æ¥å®ç°ã€‚

------

### SpringAOPä¸»è¦æƒ³è§£å†³ä»€ä¹ˆé—®é¢˜

å®ƒçš„ç›®çš„æ˜¯å¯¹äºé¢å‘å¯¹è±¡æ€ç»´çš„ä¸€ç§è¡¥å……ï¼Œè€Œä¸æ˜¯åƒå¼•å…¥å‘½ä»¤å¼ã€å‡½æ•°å¼ç¼–ç¨‹æ€ç»´è®©ä»–é¡ºåº”å¦ä¸€ç§å¼€å‘åœºæ™¯ã€‚åœ¨æˆ‘ä¸ªäººçš„ç†è§£ä¸‹==AOPæ›´åƒæ˜¯ä¸€ç§å¯¹äºä¸æ”¯æŒå¤šç»§æ‰¿çš„å¼¥è¡¥==ï¼Œé™¤å¼€å¯¹è±¡çš„ä¸»è¦ç‰¹å¾ï¼ˆæˆ‘æ›´å–œæ¬¢å«â€œå¼ºå…±æ€§â€ï¼‰è¢«æŠ½è±¡ä¸ºäº†ä¸€æ¡ç»§æ‰¿é“¾è·¯ï¼Œ==å¯¹äºä¸€äº›â€œå¼±å…±æ€§â€ï¼ŒAOPå¯ä»¥ç»Ÿä¸€å¯¹ä»–ä»¬è¿›è¡ŒæŠ½è±¡å’Œé›†ä¸­å¤„ç†ã€‚==

ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ‰“å°æ—¥å¿—ã€‚éœ€è¦æ‰“å°æ—¥å¿—å¯èƒ½æ˜¯è®¸å¤šå¯¹è±¡çš„ä¸€ä¸ªå…±æ€§ï¼Œè¿™åœ¨ä¼ä¸šçº§å¼€å‘ä¸­ååˆ†å¸¸è§ï¼Œä½†æ˜¯æ—¥å¿—çš„æ‰“å°å¹¶ä¸ååº”è¿™ä¸ªå¯¹è±¡çš„ä¸»è¦å…±æ€§ã€‚è€Œæ—¥å¿—çš„æ‰“å°åˆæ˜¯ä¸€ä¸ªå…·ä½“çš„å†…å®¹ï¼Œå®ƒå¹¶ä¸æŠ½è±¡ï¼Œæ‰€ä»¥å®ƒçš„å·¥ä½œä¹Ÿä¸å¯ä»¥ç”¨æ¥å£æ¥å®Œæˆã€‚è€Œå¦‚æœåˆ©ç”¨ç»§æ‰¿ï¼Œæ‰“å°æ—¥å¿—çš„å·¥ä½œåˆæ¨ªè·¨ç»§æ‰¿æ ‘ä¸‹é¢çš„å¤šä¸ªåŒçº§å­èŠ‚ç‚¹ï¼Œå¼ºè¡Œä¾µå…¥åˆ°ç»§æ‰¿æ ‘å†…è¿›è¡Œå½’çº³ä¼šå¹²æ‰°è¿™äº›å¼ºå…±æ€§çš„åŒºåˆ†ã€‚

è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦AOPäº†ã€‚AOPé¦–å…ˆåœ¨ä¸€ä¸ªAspectï¼ˆåˆ‡é¢ï¼‰é‡Œå®šä¹‰äº†ä¸€äº›Adviceï¼ˆå¢å¼ºï¼‰ï¼Œå…¶ä¸­åŒ…å«å…·ä½“å®ç°çš„ä»£ç ï¼ŒåŒæ—¶æ•´ç†äº†åˆ‡å…¥ç‚¹ï¼Œåˆ‡å…¥ç‚¹çš„ç²’åº¦æ˜¯æ–¹æ³•ã€‚æœ€åï¼Œæˆ‘ä»¬å°†è¿™äº›Adviceç»‡å…¥åˆ°å¯¹è±¡çš„æ–¹æ³•ä¸Šï¼Œå½¢æˆäº†æœ€åæ‰§è¡Œæ–¹æ³•æ—¶é¢å¯¹çš„å®Œæ•´æ–¹æ³•ã€‚

![img](https://cdn.xiaolincoding.com//picgo/1716791217083-132fe2ba-706a-4d8d-aef3-1617a2046585.png)

------

### åŠ¨æ€ä»£ç†æ˜¯ä»€ä¹ˆï¼Ÿ

Javaçš„åŠ¨æ€ä»£ç†æ˜¯ä¸€ç§åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡çš„æœºåˆ¶ï¼Œä¸»è¦ç”¨äºåœ¨ä¸ä¿®æ”¹åŸå§‹ç±»çš„æƒ…å†µä¸‹å¯¹æ–¹æ³•è°ƒç”¨è¿›è¡Œæ‹¦æˆªå’Œå¢å¼ºã€‚

JavaåŠ¨æ€ä»£ç†ä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

- **åŸºäºæ¥å£çš„ä»£ç†**ï¼ˆJDKåŠ¨æ€ä»£ç†ï¼‰ï¼š è¿™ç§ç±»å‹çš„ä»£ç†è¦æ±‚ç›®æ ‡å¯¹è±¡å¿…é¡»å®ç°è‡³å°‘ä¸€ä¸ªæ¥å£ã€‚JavaåŠ¨æ€ä»£ç†ä¼šåˆ›å»ºä¸€ä¸ªå®ç°äº†ç›¸åŒæ¥å£çš„ä»£ç†ç±»ï¼Œç„¶ååœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆè¯¥ç±»çš„å®ä¾‹ã€‚è¿™ç§ä»£ç†çš„å®ç°æ ¸å¿ƒæ˜¯`java.lang.reflect.Proxy`ç±»å’Œ`java.lang.reflect.InvocationHandler`æ¥å£ã€‚æ¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»éƒ½å¿…é¡»å®ç°`InvocationHandler`æ¥å£ï¼Œå¹¶ä¸”æ¯ä¸ªä»£ç†ç±»çš„å®ä¾‹éƒ½å…³è”åˆ°ä¸€ä¸ª`handler`ã€‚å½“é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ä¼šè¢«è½¬å‘ä¸ºç”±`InvocationHandler`æ¥å£çš„`invoke()`æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ã€‚
- **åŸºäºç±»çš„ä»£ç†**ï¼ˆCGLIBåŠ¨æ€ä»£ç†ï¼‰ï¼š CGLIBï¼ˆCode Generation Libraryï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”Ÿæˆåº“ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä¸€ä¸ªç›®æ ‡ç±»çš„å­ç±»ã€‚CGLIBä»£ç†ä¸éœ€è¦ç›®æ ‡ç±»å®ç°æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡ç»§æ‰¿çš„æ–¹å¼åˆ›å»ºä»£ç†ç±»ã€‚å› æ­¤ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨CGLIBæ¥åˆ›å»ºåŠ¨æ€ä»£ç†ã€‚==**Byte Buddy**é€æ¸å–ä»£==

------

### åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†çš„åŒºåˆ«

ä»£ç†æ˜¯ä¸€ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œç›®çš„æ˜¯ï¼šä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹æŸä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œå°†ä¸¤ä¸ªç±»çš„å…³ç³»è§£è€¦ã€‚ä»£ç†ç±»å’Œå§”æ‰˜ç±»éƒ½è¦å®ç°ç›¸åŒçš„æ¥å£ï¼Œå› ä¸ºä»£ç†çœŸæ­£è°ƒç”¨çš„æ˜¯å§”æ‰˜ç±»çš„æ–¹æ³•ã€‚

åŒºåˆ«ï¼š

- é™æ€ä»£ç†ï¼šç”±ç¨‹åºå‘˜åˆ›å»ºæˆ–è€…æ˜¯ç”±ç‰¹å®šå·¥å…·åˆ›å»ºï¼Œåœ¨ä»£ç ç¼–è¯‘æ—¶å°±ç¡®å®šäº†è¢«ä»£ç†çš„ç±»æ˜¯ä¸€ä¸ªé™æ€ä»£ç†ã€‚é™æ€ä»£ç†é€šå¸¸åªä»£ç†ä¸€ä¸ªç±»ï¼›

  ```java
  // é™æ€ä»£ç†ç±»
  public class UserServiceProxy implements UserService {
      private UserService target; // æŒæœ‰ç›®æ ‡å¯¹è±¡
  
      public UserServiceProxy(UserService target) {
          this.target = target;
      }
  
      @Override
      public void addUser(String name) {
          System.out.println("[ä»£ç†] å‰ç½®å¢å¼º: å¼€å§‹æ·»åŠ ç”¨æˆ·");
          target.addUser(name); // è°ƒç”¨ç›®æ ‡æ–¹æ³•
          System.out.println("[ä»£ç†] åç½®å¢å¼º: æ·»åŠ å®Œæˆ");
      }
  
      @Override
      public void deleteUser(int id) {
          System.out.println("[ä»£ç†] å‰ç½®å¢å¼º: å¼€å§‹åˆ é™¤ç”¨æˆ·");
          target.deleteUser(id);
          System.out.println("[ä»£ç†] åç½®å¢å¼º: åˆ é™¤å®Œæˆ");
      }
  }
  ```

  ```java
  public class Main {
      public static void main(String[] args) {
          // åˆ›å»ºç›®æ ‡å¯¹è±¡
          UserService target = new UserServiceImpl();
          
          // åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆæ‰‹åŠ¨åŒ…è£…ç›®æ ‡å¯¹è±¡ï¼‰
          UserService proxy = new UserServiceProxy(target);
          
          // é€šè¿‡ä»£ç†è°ƒç”¨æ–¹æ³•
          proxy.addUser("Alice");
          proxy.deleteUser(123);
      }
  }
  ```

- åŠ¨æ€ä»£ç†ï¼šåœ¨ä»£ç è¿è¡ŒæœŸé—´ï¼Œè¿ç”¨åå°„æœºåˆ¶åŠ¨æ€åˆ›å»ºç”Ÿæˆã€‚åŠ¨æ€ä»£ç†ä»£ç†çš„æ˜¯ä¸€ä¸ªæ¥å£ä¸‹çš„å¤šä¸ªå®ç°ç±»ã€‚

------

### èƒ½ä½¿ç”¨é™æ€ä»£ç†çš„æ–¹å¼å®ç°AOPå—ï¼Ÿ

å½“ç„¶**å¯ä»¥**ç”¨é™æ€ä»£ç†å®ç° AOP çš„åŸºæœ¬åŠŸèƒ½ï¼Œæ¯”å¦‚ä½ åœ¨ä»£ç é‡Œæ‰‹åŠ¨å†™ä¸ªä»£ç†ç±»ï¼Œåœ¨ç›®æ ‡æ–¹æ³•å‰ååŠ æ—¥å¿—æˆ–è€…äº‹åŠ¡æ§åˆ¶ï¼ŒæŠ€æœ¯ä¸Šå®Œå…¨å¯è¡Œã€‚ä½†é—®é¢˜æ˜¯ï¼Œé™æ€ä»£ç†åœ¨å®é™…ç”Ÿäº§ä¸­åŸºæœ¬æ²¡äººç”¨ï¼Œå› ä¸ºå®ƒæœ‰ä¸‰å¤§ç¡¬ä¼¤ï¼š

- **ç¬¬ä¸€æ˜¯ä»£ç çˆ†ç‚¸**ã€‚æ¯”å¦‚ä½ æœ‰ 100 ä¸ª Service ç±»éœ€è¦åŠ äº‹åŠ¡ï¼Œå°±å¾—å†™ 100 ä¸ªå¯¹åº”çš„é™æ€ä»£ç†ç±»ï¼Œé‡Œé¢å…¨æ˜¯é‡å¤çš„ `try-catch` æäº¤å›æ»šä»£ç ï¼Œç»´æŠ¤èµ·æ¥ç®€ç›´æ˜¯ç¾éš¾ã€‚
- **ç¬¬äºŒæ˜¯åƒµåŒ–**ã€‚ä¸€æ—¦ä¸šåŠ¡æ¥å£æ”¹äº†ä¸ªæ–¹æ³•åï¼Œæ‰€æœ‰ç›¸å…³çš„ä»£ç†ç±»éƒ½å¾—è·Ÿç€æ”¹ï¼Œè€ŒåŠ¨æ€ä»£ç†é€šè¿‡åå°„è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œæ ¹æœ¬ä¸æ€•è¿™ç§å˜åŠ¨ã€‚
- **ç¬¬ä¸‰æ˜¯æ— æ³•åŠ¨æ€ç­›é€‰**ã€‚æ¯”å¦‚ä½ æƒ³åªç»™å¸¦ `@Transactional` æ³¨è§£çš„æ–¹æ³•åŠ äº‹åŠ¡ï¼Œé™æ€ä»£ç†åªèƒ½å†™æ­»é€»è¾‘ï¼Œè€Œ Spring AOP å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼ç²¾å‡†åŒ¹é…éœ€è¦å¢å¼ºçš„æ–¹æ³•ã€‚

æ‰€ä»¥ Spring æ‰é€‰äº† JDK åŠ¨æ€ä»£ç†å’Œ CGLIBï¼šå®ƒä»¬èƒ½åœ¨**è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»**ï¼Œä¸€ä¸ªåˆ‡é¢é…ç½®å°±èƒ½è¦†ç›–æˆç™¾ä¸Šåƒä¸ªæ–¹æ³•ã€‚åƒäº‹åŠ¡ç®¡ç†è¿™ç§å…¨å±€éœ€æ±‚ï¼Œç”¨é™æ€ä»£ç†æ‰‹åŠ¨ç»‘å®šæ ¹æœ¬ä¸å¯è¡Œã€‚

------

### AOPå®ç°æœ‰å“ªäº›æ³¨è§£ï¼Ÿ

å¸¸ç”¨çš„æ³¨è§£åŒ…æ‹¬ï¼š

- @Aspectï¼šç”¨äºå®šä¹‰åˆ‡é¢ï¼Œæ ‡æ³¨åœ¨åˆ‡é¢ç±»ä¸Šã€‚
- @Pointcutï¼šå®šä¹‰åˆ‡ç‚¹ï¼Œæ ‡æ³¨åœ¨æ–¹æ³•ä¸Šï¼Œç”¨äºæŒ‡å®šè¿æ¥ç‚¹ã€‚
- @Beforeï¼šåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œé€šçŸ¥ã€‚
- @Afterï¼šåœ¨æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œé€šçŸ¥ã€‚
- @Aroundï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰åéƒ½æ‰§è¡Œé€šçŸ¥ã€‚
- @AfterReturningï¼šåœ¨æ–¹æ³•æ‰§è¡Œåè¿”å›ç»“æœåæ‰§è¡Œé€šçŸ¥ã€‚
- @AfterThrowingï¼šåœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œé€šçŸ¥ã€‚
- @Adviceï¼šé€šç”¨çš„é€šçŸ¥ç±»å‹ï¼Œå¯ä»¥æ›¿ä»£@Beforeã€@Afterç­‰ã€‚

------

### ä»€ä¹ˆæ˜¯åå°„ï¼Ÿæœ‰å“ªäº›ä½¿ç”¨åœºæ™¯ï¼Ÿ

åå°„æœºåˆ¶æ˜¯æŒ‡ç¨‹åºåœ¨è¿è¡ŒçŠ¶æ€ä¸‹ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤Ÿ==è·å–è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•==ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„==ä»»æ„å±æ€§å’Œæ–¹æ³•==ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJava åå°„å…è®¸åœ¨è¿è¡Œæ—¶è·å–ç±»çš„ä¿¡æ¯å¹¶åŠ¨æ€æ“ä½œå¯¹è±¡ï¼Œå³ä½¿åœ¨ç¼–è¯‘æ—¶ä¸çŸ¥é“å…·ä½“çš„ç±»ä¹Ÿèƒ½å®ç°ã€‚

åå°„å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **è¿è¡Œæ—¶ç±»ä¿¡æ¯è®¿é—®**ï¼šåå°„æœºåˆ¶å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶è·å–ç±»çš„å®Œæ•´ç»“æ„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»åã€åŒ…åã€çˆ¶ç±»ã€å®ç°çš„æ¥å£ã€æ„é€ å‡½æ•°ã€æ–¹æ³•å’Œå­—æ®µç­‰ã€‚
2. **åŠ¨æ€å¯¹è±¡åˆ›å»º**ï¼šå¯ä»¥ä½¿ç”¨åå°„APIåŠ¨æ€åœ°åˆ›å»ºå¯¹è±¡å®ä¾‹ï¼Œå³ä½¿åœ¨ç¼–è¯‘æ—¶ä¸çŸ¥é“å…·ä½“çš„ç±»åã€‚è¿™æ˜¯é€šè¿‡Classç±»çš„newInstance()æ–¹æ³•æˆ–Constructorå¯¹è±¡çš„newInstance()æ–¹æ³•å®ç°çš„ã€‚
3. **åŠ¨æ€æ–¹æ³•è°ƒç”¨**ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ç§æœ‰æ–¹æ³•ã€‚è¿™é€šè¿‡Methodç±»çš„invoke()æ–¹æ³•å®ç°ï¼Œå…è®¸ä½ ä¼ å…¥å¯¹è±¡å®ä¾‹å’Œå‚æ•°å€¼æ¥æ‰§è¡Œæ–¹æ³•ã€‚
4. **è®¿é—®å’Œä¿®æ”¹å­—æ®µå€¼**ï¼šåå°„è¿˜å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶è®¿é—®å’Œä¿®æ”¹å¯¹è±¡çš„å­—æ®µå€¼ï¼Œå³ä½¿æ˜¯ç§æœ‰çš„ã€‚è¿™æ˜¯é€šè¿‡Fieldç±»çš„get()å’Œset()æ–¹æ³•å®Œæˆçš„ã€‚

![img](https://cdn.xiaolincoding.com//picgo/1718957173277-863d2ec6-a754-423b-9066-9f28610d1a31-20240725232406027.png)

Javaåå°„æœºåˆ¶åœ¨springæ¡†æ¶ä¸­ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½ç”¨åˆ°äº†åå°„ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹Springçš„IoCå’ŒAOPæ˜¯å¦‚ä½•ä½¿ç”¨åå°„æŠ€æœ¯çš„ã€‚

> 1ã€Springæ¡†æ¶çš„ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰å’Œæ§åˆ¶åè½¬ï¼ˆIoCï¼‰

==Spring ä½¿ç”¨åå°„æ¥å®ç°å…¶æ ¸å¿ƒç‰¹æ€§ï¼šä¾èµ–æ³¨å…¥ã€‚==

åœ¨Springä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡XMLé…ç½®æ–‡ä»¶æˆ–è€…åŸºäºæ³¨è§£çš„æ–¹å¼å£°æ˜ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚å½“åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼ŒSpringå®¹å™¨ä¼šæ‰«æè¿™äº›é…ç½®æˆ–æ³¨è§£ï¼Œç„¶ååˆ©ç”¨åå°„æ¥å®ä¾‹åŒ–Beanï¼ˆå³Javaå¯¹è±¡ï¼‰ï¼Œå¹¶æ ¹æ®é…ç½®è‡ªåŠ¨è£…é…å®ƒä»¬çš„ä¾èµ–ã€‚

ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªServiceç±»éœ€è¦ä¾èµ–å¦ä¸€ä¸ªDAOç±»æ—¶ï¼Œå¼€å‘è€…å¯ä»¥åœ¨Serviceç±»ä¸­ä½¿ç”¨@Autowiredæ³¨è§£ï¼Œè€Œæ— éœ€è‡ªå·±ç¼–å†™åˆ›å»ºDAOå®ä¾‹çš„ä»£ç ã€‚Springå®¹å™¨ä¼šåœ¨è¿è¡Œæ—¶è§£æè¿™ä¸ªæ³¨è§£ï¼Œé€šè¿‡åå°„æ‰¾åˆ°å¯¹åº”çš„DAOç±»ï¼Œå®ä¾‹åŒ–å®ƒï¼Œå¹¶å°†å…¶æ³¨å…¥åˆ°Serviceç±»ä¸­ã€‚è¿™æ ·ä¸ä»…é™ä½äº†ç»„ä»¶ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä¹Ÿæå¤§åœ°å¢å¼ºäº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

> 2ã€åŠ¨æ€ä»£ç†çš„å®ç°

åœ¨éœ€è¦å¯¹ç°æœ‰ç±»çš„æ–¹æ³•è°ƒç”¨è¿›è¡Œæ‹¦æˆªã€è®°å½•æ—¥å¿—ã€æƒé™æ§åˆ¶æˆ–æ˜¯äº‹åŠ¡ç®¡ç†ç­‰åœºæ™¯ä¸­ï¼Œåå°„ç»“åˆåŠ¨æ€ä»£ç†æŠ€æœ¯è¢«å¹¿æ³›åº”ç”¨ã€‚

ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯Spring AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰çš„å®ç°ã€‚Spring AOPå…è®¸å¼€å‘è€…å®šä¹‰åˆ‡é¢ï¼ˆAspectï¼‰ï¼Œè¿™äº›åˆ‡é¢å¯ä»¥æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ï¼‰ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚

ä¾‹å¦‚ï¼Œä¸ºäº†ç»™æ‰€æœ‰çš„æœåŠ¡å±‚æ–¹æ³•æ·»åŠ æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªåˆ‡é¢ï¼Œåœ¨è¿™ä¸ªåˆ‡é¢ä¸­ï¼ŒSpringä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†æˆ–CGLIBï¼ˆå¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼‰æ¥åˆ›å»ºç›®æ ‡ç±»çš„ä»£ç†å¯¹è±¡ã€‚==è¿™ä¸ªä»£ç†å¯¹è±¡åœ¨è°ƒç”¨ä»»ä½•æ–¹æ³•å‰æˆ–åï¼Œéƒ½ä¼šæ‰§è¡Œåˆ‡é¢ä¸­å®šä¹‰çš„ä»£ç é€»è¾‘ï¼ˆå¦‚è®°å½•æ—¥å¿—ï¼‰==ï¼Œè€Œè¿™ä¸€åˆ‡éƒ½æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„æ¥åŠ¨æ€æ„å»ºå’Œæ‰§è¡Œçš„ï¼Œæ— éœ€ç¡¬ç¼–ç åˆ°æ¯ä¸ªæ–¹æ³•è°ƒç”¨ä¸­ã€‚

è¿™ä¸¤ä¸ªä¾‹å­å±•ç¤ºäº†åå°„æœºåˆ¶å¦‚ä½•åœ¨å®é™…å·¥ç¨‹ä¸­ä¿ƒè¿›**æ¾è€¦åˆã€é«˜å†…èš**çš„è®¾è®¡ï¼Œä»¥åŠå¦‚ä½•æä¾›åŠ¨æ€ã€çµæ´»çš„ç¼–ç¨‹èƒ½åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¡†æ¶å±‚é¢å’Œè§£å†³è·¨åˆ‡é¢é—®é¢˜æ—¶ã€‚

------

### Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ

å¾ªç¯ä¾èµ–æŒ‡çš„æ˜¯ä¸¤ä¸ªç±»ä¸­çš„å±æ€§ç›¸äº’ä¾èµ–å¯¹æ–¹ï¼šä¾‹å¦‚ A ç±»ä¸­æœ‰ B å±æ€§ï¼ŒB ç±»ä¸­æœ‰ Aå±æ€§ï¼Œä»è€Œå½¢æˆäº†ä¸€ä¸ªä¾èµ–é—­ç¯ï¼Œå¦‚ä¸‹å›¾ã€‚

![img](https://cdn.xiaolincoding.com//picgo/1720684589425-d06727ba-bf03-484a-b656-c225554b5b49.png)

å¾ªç¯ä¾èµ–é—®é¢˜åœ¨Springä¸­ä¸»è¦æœ‰ä¸‰ç§æƒ…å†µï¼š

- ç¬¬ä¸€ç§ï¼šé€šè¿‡æ„é€ æ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥æ—¶äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚
- ç¬¬äºŒç§ï¼šé€šè¿‡setteræ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ä¸”æ˜¯åœ¨å¤šä¾‹ï¼ˆåŸå‹ï¼‰æ¨¡å¼ä¸‹äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚
- ç¬¬ä¸‰ç§ï¼šé€šè¿‡setteræ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ä¸”æ˜¯åœ¨å•ä¾‹æ¨¡å¼ä¸‹äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚

åªæœ‰ã€ç¬¬ä¸‰ç§æ–¹å¼ã€‘çš„å¾ªç¯ä¾èµ–é—®é¢˜è¢« Spring è§£å†³äº†ï¼Œå…¶ä»–ä¸¤ç§æ–¹å¼åœ¨é‡åˆ°å¾ªç¯ä¾èµ–é—®é¢˜æ—¶ï¼ŒSpringéƒ½ä¼šäº§ç”Ÿå¼‚å¸¸ã€‚

Spring åœ¨ `DefaultSingletonBeanRegistry` ç±»ä¸­ç»´æŠ¤äº†ä¸‰ä¸ªé‡è¦çš„ç¼“å­˜ (Map)ï¼Œç§°ä¸ºâ€œä¸‰çº§ç¼“å­˜â€ï¼š

- `singletonObjects` (ä¸€çº§ç¼“å­˜)ï¼š==å­˜æ”¾çš„æ˜¯å®Œå…¨åˆå§‹åŒ–å¥½çš„ã€å¯ç”¨çš„ Bean å®ä¾‹==ï¼Œ`getBean()` æ–¹æ³•æœ€ç»ˆè¿”å›çš„å°±æ˜¯è¿™é‡Œé¢çš„ Beanã€‚æ­¤æ—¶ Bean å·²å®ä¾‹åŒ–ã€å±æ€§å·²å¡«å……ã€åˆå§‹åŒ–æ–¹æ³•å·²æ‰§è¡Œã€==AOP ä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰ä¹Ÿå·²ç”Ÿæˆã€‚==
- `earlySingletonObjects` (äºŒçº§ç¼“å­˜)ï¼šå­˜æ”¾çš„æ˜¯æå‰==æš´éœ²çš„ Bean çš„åŸå§‹å¯¹è±¡å¼•ç”¨ æˆ– æ—©æœŸä»£ç†å¯¹è±¡å¼•ç”¨==ï¼Œ==ä¸“é—¨ç”¨æ¥å¤„ç†å¾ªç¯ä¾èµ–==ã€‚==å½“ä¸€ä¸ª Bean è¿˜åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼ˆå°šæœªå®Œæˆå±æ€§å¡«å……å’Œåˆå§‹åŒ–ï¼‰==ï¼Œä½†å®ƒçš„å¼•ç”¨éœ€è¦è¢«æ³¨å…¥åˆ°å¦ä¸€ä¸ª Bean æ—¶ï¼Œå°±æš‚æ—¶æ”¾åœ¨è¿™é‡Œã€‚æ­¤æ—¶ Bean å·²å®ä¾‹åŒ–ï¼ˆè°ƒç”¨äº†æ„é€ å‡½æ•°ï¼‰ï¼Œä½†å±æ€§å°šæœªå¡«å……ï¼Œåˆå§‹åŒ–æ–¹æ³•å°šæœªæ‰§è¡Œï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªåŸå§‹å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªä¸ºäº†è§£å†³ AOP ä»£ç†é—®é¢˜è€Œæå‰ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ã€‚
- `singletonFactories` (ä¸‰çº§ç¼“å­˜)ï¼šå­˜æ”¾çš„æ˜¯ Bean çš„ `ObjectFactory` å·¥å‚å¯¹è±¡ã€‚ï¼Œè¿™æ˜¯==è§£å†³å¾ªç¯ä¾èµ–å’Œ AOP ä»£ç†ååŒå·¥ä½œçš„å…³é”®==ã€‚==å½“ Bean è¢«å®ä¾‹åŒ–åï¼ˆåˆšè°ƒå®Œæ„é€ å‡½æ•°ï¼‰ï¼ŒSpring ä¼šåˆ›å»ºä¸€ä¸ª `ObjectFactory` å¹¶å°†å…¶æ”¾å…¥ä¸‰çº§ç¼“å­˜ã€‚==è¿™ä¸ªå·¥å‚çš„ `getObject()` æ–¹æ³•è´Ÿè´£è¿”å›è¯¥ Bean çš„æ—©æœŸå¼•ç”¨ï¼ˆå¯èƒ½æ˜¯åŸå§‹å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯æå‰ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼‰ï¼Œå½“æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–éœ€è¦æ³¨å…¥ä¸€ä¸ªå°šæœªå®Œå…¨åˆå§‹åŒ–çš„ Bean æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå·¥å‚æ¥è·å–==æ—©æœŸå¼•ç”¨==ã€‚

| **ç¼“å­˜çº§åˆ«** | **åç§°**                | **å­˜å‚¨å†…å®¹**                                   | **ç›®çš„**                              |
| :----------- | :---------------------- | :--------------------------------------------- | :------------------------------------ |
| **ä¸€çº§ç¼“å­˜** | `singletonObjects`      | å®Œå…¨åˆå§‹åŒ–åçš„å•ä¾‹ Bean                        | æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„æœ€ç»ˆæˆå“              |
| **äºŒçº§ç¼“å­˜** | `earlySingletonObjects` | æå‰æš´éœ²çš„â€œåŠæˆå“â€Beanï¼ˆå·²å®ä¾‹åŒ–ä½†æœªæ³¨å…¥ä¾èµ–ï¼‰ | è§£å†³å¾ªç¯ä¾èµ–æ—¶ä¸´æ—¶å­˜æ”¾                |
| **ä¸‰çº§ç¼“å­˜** | `singletonFactories`    | Bean çš„å·¥å‚å¯¹è±¡ï¼ˆ`ObjectFactory`ï¼‰             | ç”¨äºç”Ÿæˆæ—©æœŸå¼•ç”¨ï¼ˆè§£å†³ AOP ä»£ç†é—®é¢˜ï¼‰ |

Spring é€šè¿‡ ä¸‰çº§ç¼“å­˜ å’Œ æå‰æš´éœ²æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡å¼•ç”¨ çš„æœºåˆ¶æ¥è§£å†³å•ä¾‹ä½œç”¨åŸŸ Bean çš„ setteæ³¨å…¥æ–¹å¼çš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚

å‡è®¾å­˜åœ¨ä¸¤ä¸ªç›¸äº’ä¾èµ–çš„å•ä¾‹Beanï¼š`BeanA` ä¾èµ– `BeanB`ï¼ŒåŒæ—¶ `BeanB` ä¹Ÿä¾èµ– `BeanA`ã€‚å½“Springå®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæŒ‰ç…§ä»¥ä¸‹æµç¨‹å¤„ç†ï¼š

- ç¬¬ä¸€æ­¥ï¼šåˆ›å»º`BeanA`çš„å®ä¾‹å¹¶æå‰æš´éœ²å·¥å‚ã€‚

Springé¦–å…ˆè°ƒç”¨`BeanA`çš„æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–ï¼Œæ­¤æ—¶å¾—åˆ°ä¸€ä¸ªåŸå§‹å¯¹è±¡ï¼ˆå°šæœªå¡«å……å±æ€§ï¼‰ã€‚ç´§æ¥ç€ï¼ŒSpringä¼šå°†ä¸€ä¸ªç‰¹æ®Šçš„`ObjectFactory`å·¥å‚å¯¹è±¡å­˜å…¥ç¬¬ä¸‰çº§ç¼“å­˜ï¼ˆ`singletonFactories`ï¼‰ã€‚è¿™ä¸ªå·¥å‚çš„ä½¿å‘½æ˜¯ï¼šå½“å…¶ä»–Beanéœ€è¦å¼•ç”¨`BeanA`æ—¶ï¼Œå®ƒèƒ½åŠ¨æ€è¿”å›å½“å‰è¿™ä¸ªåŠæˆå“çš„`BeanA`ï¼ˆå¯èƒ½æ˜¯åŸå§‹å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸ºåº”å¯¹AOPè€Œæå‰ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼‰ã€‚æ­¤æ—¶`BeanA`çš„çŠ¶æ€æ˜¯"å·²å®ä¾‹åŒ–ä½†æœªåˆå§‹åŒ–"ï¼Œåƒä¸€åº§åˆšæ­å¥½é’¢ç­‹éª¨æ¶çš„å¤§æ¥¼ã€‚

- ç¬¬äºŒæ­¥ï¼šå¡«å……`BeanA`çš„å±æ€§æ—¶è§¦å‘`BeanB`çš„åˆ›å»ºã€‚

Springå¼€å§‹ä¸º`BeanA`æ³¨å…¥å±æ€§ï¼Œå‘ç°å®ƒä¾èµ–`BeanB`ã€‚äºæ˜¯å®¹å™¨è½¬å‘åˆ›å»º`BeanB`ï¼ŒåŒæ ·å…ˆè°ƒç”¨å…¶æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼Œå¹¶å°†`BeanB`å¯¹åº”çš„`ObjectFactory`å·¥å‚å­˜å…¥ä¸‰çº§ç¼“å­˜ã€‚è‡³æ­¤ï¼Œä¸‰çº§ç¼“å­˜ä¸­åŒæ—¶å­˜åœ¨`BeanA`å’Œ`BeanB`çš„å·¥å‚ï¼Œå®ƒä»¬éƒ½ä»£è¡¨æœªå®Œæˆåˆå§‹åŒ–çš„åŠæˆå“ã€‚

- ç¬¬ä¸‰æ­¥ï¼š`BeanB`å±æ€§æ³¨å…¥æ—¶å‘ç°å¾ªç¯ä¾èµ–ã€‚

å½“Springè¯•å›¾å¡«å……`BeanB`çš„å±æ€§æ—¶ï¼Œæ£€æµ‹åˆ°å®ƒéœ€è¦æ³¨å…¥`BeanA`ã€‚æ­¤æ—¶å®¹å™¨å¯åŠ¨ä¾èµ–æŸ¥æ‰¾ï¼š

1. åœ¨ä¸€çº§ç¼“å­˜ï¼ˆå­˜æ”¾å®Œæ•´Beanï¼‰ä¸­æœªæ‰¾åˆ°`BeanA`ï¼›
2. åœ¨äºŒçº§ç¼“å­˜ï¼ˆå­˜æ”¾å·²æš´éœ²çš„æ—©æœŸå¼•ç”¨ï¼‰ä¸­åŒæ ·æœªå‘½ä¸­ï¼›
3. æœ€ç»ˆåœ¨ä¸‰çº§ç¼“å­˜ä¸­å®šä½åˆ°`BeanA`çš„å·¥å‚ã€‚

Springç«‹å³è°ƒç”¨è¯¥å·¥å‚çš„`getObject()`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šæ‰§è¡Œå…³é”®å†³ç­–ï¼šè‹¥`BeanA`éœ€è¦AOPä»£ç†ï¼Œåˆ™åŠ¨æ€ç”Ÿæˆä»£ç†å¯¹è±¡ï¼ˆå³ä½¿`BeanA`è¿˜æœªåˆå§‹åŒ–ï¼‰ï¼›è‹¥æ— éœ€ä»£ç†ï¼Œåˆ™ç›´æ¥è¿”å›åŸå§‹å¯¹è±¡ã€‚å¾—åˆ°çš„è¿™ä¸ªæ—©æœŸå¼•ç”¨ï¼ˆå¯èƒ½æ˜¯ä»£ç†ï¼‰è¢«æ”¾å…¥äºŒçº§ç¼“å­˜ï¼ˆ`earlySingletonObjects`ï¼‰ï¼ŒåŒæ—¶ä»ä¸‰çº§ç¼“å­˜æ¸…ç†å·¥å‚æ¡ç›®ã€‚æœ€åï¼ŒSpringå°†è¿™ä¸ªæ—©æœŸå¼•ç”¨æ³¨å…¥åˆ°`BeanB`çš„å±æ€§ä¸­ã€‚è‡³æ­¤ï¼Œ`BeanB`æˆåŠŸæŒæœ‰`BeanA`çš„å¼•ç”¨â€”â€”å°½ç®¡`BeanA`æ­¤æ—¶ä»æ˜¯ä¸ªåŠæˆå“ã€‚

- ç¬¬å››æ­¥ï¼šå®Œæˆ`BeanB`çš„ç”Ÿå‘½å‘¨æœŸã€‚

`BeanB`è·å¾—æ‰€æœ‰ä¾èµ–åï¼ŒSpringæ‰§è¡Œå…¶åˆå§‹åŒ–æ–¹æ³•ï¼ˆå¦‚`@PostConstruct`ï¼‰ï¼Œå°†å…¶è½¬åŒ–ä¸ºå®Œæ•´å¯ç”¨çš„Beanã€‚éšåï¼Œ`BeanB`è¢«æå‡è‡³ä¸€çº§ç¼“å­˜ï¼ˆ`singletonObjects`ï¼‰ï¼ŒäºŒçº§å’Œä¸‰çº§ç¼“å­˜ä¸­å…³äº`BeanB`çš„ä¸´æ—¶æ¡ç›®å‡è¢«æ¸…é™¤ã€‚æ­¤æ—¶`BeanB`å·²å‡†å¤‡å°±ç»ªï¼Œå¯è¢«å…¶ä»–å¯¹è±¡ä½¿ç”¨ã€‚

- ç¬¬äº”æ­¥ï¼šå›æº¯å®Œæˆ`BeanA`çš„æ„å»ºã€‚

éšç€`BeanB`åˆ›å»ºå®Œæ¯•ï¼Œæµç¨‹å›æº¯åˆ°æœ€åˆä¸­æ–­çš„`BeanA`å±æ€§æ³¨å…¥ç¯èŠ‚ã€‚Springå°†å·²å®Œå¤‡çš„`BeanB`å®ä¾‹æ³¨å…¥`BeanA`ï¼Œæ¥ç€æ‰§è¡Œ`BeanA`çš„åˆå§‹åŒ–æ–¹æ³•ã€‚è¿™é‡Œæœ‰ä¸ªç²¾å¦™ç»†èŠ‚ï¼šè‹¥ä¹‹å‰ä¸º`BeanA`ç”Ÿæˆè¿‡æ—©æœŸä»£ç†ï¼ŒSpringä¼šç›´æ¥å¤ç”¨äºŒçº§ç¼“å­˜ä¸­çš„ä»£ç†å¯¹è±¡ä½œä¸ºæœ€ç»ˆBeanï¼Œè€Œéé‡å¤åˆ›å»ºã€‚æœ€ç»ˆï¼Œå®Œå…¨åˆå§‹åŒ–çš„`BeanA`ï¼ˆå¯èƒ½æ˜¯åŸå§‹å¯¹è±¡æˆ–ä»£ç†ï¼‰å…¥é©»ä¸€çº§ç¼“å­˜ï¼Œå…¶æ—©æœŸå¼•ç”¨ä»äºŒçº§ç¼“å­˜ç§»é™¤ã€‚è‡³æ­¤å¾ªç¯é—­ç¯å®Œæˆï¼Œä¸¤ä¸ªBeançš†å¯ç”¨ã€‚

ä¸‰çº§ç¼“å­˜çš„è®¾è®¡çš„ç²¾é«“ï¼š

- **ä¸‰çº§ç¼“å­˜å·¥å‚**ï¼ˆ`singletonFactories`ï¼‰è´Ÿè´£åœ¨å®ä¾‹åŒ–åç«‹åˆ»æš´éœ²å¯¹è±¡ç”Ÿæˆèƒ½åŠ›ï¼Œå…¼é¡¾AOPä»£ç†çš„æå‰ç”Ÿæˆï¼›
- **äºŒçº§ç¼“å­˜**ï¼ˆ`earlySingletonObjects`ï¼‰ä¸´æ—¶å­˜å‚¨å·²ç¡®å®šçš„æ—©æœŸå¼•ç”¨ï¼Œé¿å…é‡å¤ç”Ÿæˆä»£ç†ï¼› ==(ä¿è¯å•ä¾‹)==
- **ä¸€çº§ç¼“å­˜**ï¼ˆ`singletonObjects`ï¼‰æœ€ç»ˆäº¤ä»˜å®Œæ•´Beanã€‚

æ•´ä¸ªæœºåˆ¶é€šè¿‡**ä¸­æ–­åˆå§‹åŒ–æµç¨‹ã€é€†å‘æ³¨å…¥åŠæˆå“ã€å»¶è¿Ÿä»£ç†ç”Ÿæˆ**ä¸‰å¤§ç­–ç•¥ï¼Œå°†å¾ªç¯ä¾èµ–çš„æ­»ç»“è½¬åŒ–ä¸ºæœ‰åºçš„æ¥åŠ›åä½œã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ–¹æ¡ˆä»…é€‚ç”¨äºSetter/Fieldæ³¨å…¥çš„**å•ä¾‹Bean**ï¼›æ„é€ å™¨æ³¨å…¥å› å¿…é¡»åœ¨å®ä¾‹åŒ–å‰è·å¾—ä¾èµ–ï¼Œä»ä¼šå¯¼è‡´æ— è§£çš„æ­»é”ã€‚

```
åˆ›å»º A â†’ ä¸‰çº§ç¼“å­˜ï¼ˆAå·¥å‚ï¼‰
   â†“
æ³¨å…¥ B â†’ åˆ›å»º B â†’ ä¸‰çº§ç¼“å­˜ï¼ˆBå·¥å‚ï¼‰
   â†“
æ³¨å…¥ A â†’ ä»ä¸‰çº§ç¼“å­˜æ‹¿åˆ° A çš„æ—©æœŸå¼•ç”¨ â†’ å‡çº§åˆ°äºŒçº§ç¼“å­˜
   â†“
å®Œæˆ B â†’ ç§»å…¥ä¸€çº§ç¼“å­˜
   â†“
å®Œæˆ A â†’ ç§»å…¥ä¸€çº§ç¼“å­˜
```

==**äºŒçº§ç¼“å­˜å‡çº§æ—¶æœº**ï¼šå½“å…¶ä»– Beanï¼ˆå¦‚ `B`ï¼‰éœ€è¦æ³¨å…¥å½“å‰ Beanï¼ˆå¦‚ `A`ï¼‰æ—¶ï¼Œ`A`çš„æ—©æœŸå¼•ç”¨ä¼šä»ä¸‰çº§ç¼“å­˜å‡çº§åˆ°äºŒçº§ç¼“å­˜ã€‚==

------

### Springä¸ºä»€ä¹ˆç”¨3çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Ÿç”¨2çº§ç¼“å­˜ä¸è¡Œå—ï¼Ÿ

Spring å¿…é¡»ç”¨ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Œæ ¸å¿ƒæ˜¯ä¸ºäº†**æ­£ç¡®å¤„ç†éœ€è¦ AOP ä»£ç†çš„ Bean**ã€‚å¦‚æœåªç”¨äºŒçº§ç¼“å­˜ï¼Œä¼šå¯¼è‡´æ³¨å…¥çš„å¯¹è±¡å½¢æ€é”™è¯¯ï¼Œç”šè‡³ç ´åå•ä¾‹åŸåˆ™ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾ Bean A ä¾èµ– Bï¼ŒB åˆä¾èµ– Aï¼Œä¸” A éœ€è¦è¢«åŠ¨æ€ä»£ç†ï¼ˆæ¯”å¦‚åŠ äº† `@Transactional`ï¼‰ã€‚==å¦‚æœåªæœ‰äºŒçº§ç¼“å­˜ï¼Œå½“ B åˆ›å»ºæ—¶å»æ³¨å…¥ Aï¼Œæ‹¿åˆ°çš„æ˜¯ A çš„åŸå§‹å¯¹è±¡ã€‚ä½† A åœ¨åç»­åˆå§‹åŒ–å®Œæˆåæ‰ä¼šç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œç»“æœå°±æ˜¯ï¼šB æ‹¿ç€åŸå§‹å¯¹è±¡ Aï¼Œè€Œ Spring å®¹å™¨é‡Œå­˜çš„æ˜¯ä»£ç†å¯¹è±¡ A== â€”â€” åŒä¸€ä¸ª Bean å‡ºç°äº†ä¸¤ä¸ªä¸åŒå®ä¾‹ï¼Œè¿™ç›´æ¥è¿åäº†å•ä¾‹çš„æ ¸å¿ƒçº¦æŸã€‚

ä¸‰çº§ç¼“å­˜ä¸­çš„ `ObjectFactory` å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„å…³é”®ã€‚å®ƒä¸æ˜¯ç›´æ¥ç¼“å­˜å¯¹è±¡ï¼Œè€Œæ˜¯å­˜äº†ä¸€ä¸ªèƒ½ç”Ÿäº§å¯¹è±¡çš„å·¥å‚ã€‚å½“å‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œè°ƒç”¨è¿™ä¸ªå·¥å‚çš„ `getObject()` æ–¹æ³•ï¼Œ==è¿™æ—¶ Spring ä¼šæ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœè¿™ä¸ª Bean æœ€ç»ˆéœ€è¦ä»£ç†ï¼Œå°±æå‰ç”Ÿæˆä»£ç†å¯¹è±¡å¹¶æ”¾å…¥äºŒçº§ç¼“å­˜ï¼›==å¦‚æœä¸éœ€è¦ä»£ç†ï¼Œå°±è¿”å›åŸå§‹å¯¹è±¡ã€‚è¿™æ ·ä¸€æ¥ï¼ŒB æ³¨å…¥çš„ A å°±æ˜¯æœ€ç»ˆå½¢æ€ï¼ˆå¯èƒ½æ˜¯ä»£ç†å¯¹è±¡ï¼‰ï¼Œåç»­ A åˆå§‹åŒ–å®Œæˆåä¹Ÿä¸ä¼šå†åˆ›å»ºæ–°ä»£ç†ï¼Œä¿è¯äº†å¯¹è±¡å…¨å±€å”¯ä¸€ã€‚

ç®€å•è¯´ï¼Œä¸‰çº§ç¼“å­˜çš„æœ¬è´¨æ˜¯ **â€œæŒ‰éœ€å»¶è¿Ÿç”Ÿæˆæ­£ç¡®å¼•ç”¨â€** ã€‚å®ƒæ—¢ç»´æŒäº† Bean ç”Ÿå‘½å‘¨æœŸçš„å®Œæ•´æ€§ï¼ˆæ­£å¸¸æµç¨‹åœ¨åˆå§‹åŒ–åç”Ÿæˆä»£ç†ï¼‰ï¼Œåˆåœ¨å¾ªç¯ä¾èµ–æ—¶ç‰¹æ®Šå¤„ç†ï¼Œé¿å…é€»è¾‘çŸ›ç›¾ã€‚è€ŒäºŒçº§ç¼“å­˜ç¼ºä¹è¿™ç§åŠ¨æ€å†³ç­–èƒ½åŠ›ï¼Œå› æ­¤æ— æ³•æ›¿ä»£ä¸‰çº§ç¼“å­˜ã€‚

------

### springä¸‰çº§ç¼“å­˜çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ

éƒ½æ˜¯ Mapç±»å‹çš„ç¼“å­˜ï¼Œæ¯”å¦‚Map {k:name; v:bean}ã€‚

1. **ä¸€çº§ç¼“å­˜ï¼ˆSingleton Objectsï¼‰**ï¼šè¿™æ˜¯ä¸€ä¸ªMapç±»å‹çš„ç¼“å­˜ï¼Œ==å­˜å‚¨çš„æ˜¯å·²ç»å®Œå…¨åˆå§‹åŒ–å¥½çš„bean==ï¼Œå³å®Œå…¨å‡†å¤‡å¥½å¯ä»¥ä½¿ç”¨çš„beanå®ä¾‹ã€‚==é”®æ˜¯beançš„åç§°ï¼Œå€¼æ˜¯beançš„å®ä¾‹==ã€‚è¿™ä¸ªç¼“å­˜åœ¨`DefaultSingletonBeanRegistry`ç±»ä¸­çš„`singletonObjects`å±æ€§ä¸­ã€‚
2. **äºŒçº§ç¼“å­˜ï¼ˆEarly Singleton Objectsï¼‰**ï¼šè¿™åŒæ ·æ˜¯ä¸€ä¸ªMapç±»å‹çš„ç¼“å­˜ï¼Œå­˜å‚¨çš„æ˜¯æ—©æœŸçš„beanå¼•ç”¨ï¼Œå³==å·²ç»å®ä¾‹åŒ–ä½†è¿˜æœªå®Œå…¨åˆå§‹åŒ–çš„bean==ã€‚è¿™äº›beanå·²ç»è¢«å®ä¾‹åŒ–ï¼Œä½†æ˜¯å¯èƒ½è¿˜æ²¡æœ‰è¿›è¡Œå±æ€§æ³¨å…¥ç­‰æ“ä½œã€‚è¿™ä¸ªç¼“å­˜åœ¨`DefaultSingletonBeanRegistry`ç±»ä¸­çš„`earlySingletonObjects`å±æ€§ä¸­ã€‚
3. **ä¸‰çº§ç¼“å­˜ï¼ˆSingleton Factoriesï¼‰**ï¼šè¿™ä¹Ÿæ˜¯ä¸€ä¸ªMapç±»å‹çš„ç¼“å­˜ï¼Œå­˜å‚¨çš„æ˜¯==ObjectFactory==å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡==å¯ä»¥ç”Ÿæˆæ—©æœŸçš„beanå¼•ç”¨==ã€‚å½“ä¸€ä¸ªbeanæ­£åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®ƒè¢«å…¶ä»–beanä¾èµ–ï¼Œé‚£ä¹ˆè¿™ä¸ªæ­£åœ¨åˆ›å»ºçš„beanå°±ä¼šé€šè¿‡è¿™ä¸ªObjectFactoryæ¥åˆ›å»ºä¸€ä¸ªæ—©æœŸå¼•ç”¨ï¼Œä»è€Œè§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚è¿™ä¸ªç¼“å­˜åœ¨`DefaultSingletonBeanRegistry`ç±»ä¸­çš„`singletonFactories`å±æ€§ä¸­ã€‚





**åˆ†ä¸ºæœ‰aop æ— aop åˆ›å»ºä»£ç†æ—¶æœºåˆ†ç±» äºŒçº§ç¼“å­˜ï¼šå¤šä¸ªå¾ªç¯ä¾èµ–å‘ç”Ÿæ—¶**

**ä¸ºä»€ä¹ˆä¸èƒ½ä¸€å¼€å§‹å°±æ£€æŸ¥ä»£ç†ï¼Ÿ å¦‚æœæ‰€æœ‰ Bean åœ¨å®ä¾‹åŒ–æ—¶éƒ½æ£€æŸ¥æ˜¯å¦éœ€è¦ä»£ç†ï¼Ÿ**

â€‹	**æ­£å¸¸æƒ…å†µ**ï¼šA åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰è¢« `AbstractAutoProxyCreator` åˆ¤æ–­æ˜¯å¦è¦ä»£ç†ã€‚

â€‹	**å¾ªç¯ä¾èµ–æƒ…å†µ**ï¼šå½“ B éœ€è¦ A æ—¶ï¼Œä¼šä»ä¸‰çº§ç¼“å­˜è§¦å‘ `getEarlyBeanReference()`ï¼Œæ­¤æ—¶å°±ä¼šè°ƒç”¨ `AbstractAutoProxyCreator` æå‰åˆ¤æ–­å¹¶ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚	

- AOP ä»£ç†æ˜¯é€šè¿‡ `AbstractAutoProxyCreator` è¿™æ ·çš„ **BeanPostProcessor** æ¥å†³å®šçš„ã€‚
- `BeanPostProcessor` çš„è°ƒç”¨æ—¶æœºæ˜¯åœ¨ **Bean å®ä¾‹åŒ–ä¹‹åã€åˆå§‹åŒ–ä¹‹å‰**ã€‚
- ä¹Ÿå°±æ˜¯è¯´ï¼ŒSpring åœ¨æœ€æ—© `doCreateBean` é˜¶æ®µè¿˜æ²¡æ³•çŸ¥é“ã€Œè¿™ä¸ª Bean éœ€ä¸éœ€è¦ä»£ç†ã€ã€‚

ğŸ‘‰ å¦‚æœä½ åœ¨å®ä¾‹åŒ–çš„æ—¶å€™å°±ç”Ÿæˆä»£ç†ï¼Œä¼šè·³è¿‡ `BeanPostProcessor` çš„é€»è¾‘ï¼Œå¯¼è‡´å¾ˆå¤š AOP/äº‹åŠ¡/å¢å¼ºåŠŸèƒ½å…¨éƒ½å¤±æ•ˆã€‚

**å¦‚æœæ”¹ä¸ºåœ¨ åˆ›å»º Bean æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦ä»£ç†**

çœ‹ä¼¼å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å­˜ç©¿é€ï¼Œä½†ä¼šå¸¦æ¥å‡ ä¸ªé—®é¢˜ï¼š

1. **ä¾èµ–æ³¨å…¥æ—¶æœºé”™ä¹±**
   - å¦‚æœåœ¨å®ä¾‹åŒ–åç«‹åˆ»ä»£ç†ï¼Œæ³¨å…¥å±æ€§æ—¶å¯èƒ½æ‰“åˆ°ä»£ç†å¯¹è±¡èº«ä¸Šã€‚
   - ä»£ç†å¯¹è±¡é‡Œä¸€èˆ¬æŒæœ‰ç›®æ ‡å¯¹è±¡çš„å¼•ç”¨ï¼ˆæ¯”å¦‚ JDK åŠ¨æ€ä»£ç†çš„ `InvocationHandler`ï¼ŒCGLIB çš„ `target` å­—æ®µï¼‰ï¼Œæ­¤æ—¶ç›®æ ‡å¯¹è±¡å¯èƒ½è¿˜æ²¡æ³¨å…¥å®Œä¾èµ–ï¼Œè°ƒç”¨æ–¹æ³•å°±ä¼š NPE æˆ–å‡ºé”™ã€‚
2. **BeanPostProcessor çš„æ—¶æœºå¤±æ•ˆ**
   - å¾ˆå¤š BPP éœ€è¦åœ¨å±æ€§æ³¨å…¥åæ‰èƒ½å†³å®šæ˜¯å¦å¢å¼ºï¼ˆä¾‹å¦‚äº‹åŠ¡å¢å¼ºå™¨è¦çœ‹ `@Transactional` æ˜¯å¦ç”Ÿæ•ˆï¼‰ã€‚
   - å¦‚æœåœ¨å®ä¾‹åŒ–é˜¶æ®µå°±ä»£ç†ï¼Œåç½®å¤„ç†å™¨è¿˜æ²¡è·‘åˆ°å°±å¤±æ•ˆäº†ã€‚
3. **å¾ªç¯ä¾èµ–æ›´éº»çƒ¦**
   - åœ¨ä¸‰çº§ç¼“å­˜é‡Œï¼ŒSpring æ”¾çš„æ˜¯â€œæ—©æœŸæš´éœ²å¯¹è±¡â€ï¼Œå®ƒå¯èƒ½æ˜¯åŸå§‹å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½åŒ…äº†ä¸€å±‚ä»£ç†å·¥å‚ã€‚
   - å¦‚æœä½ åœ¨ä¸€å¼€å§‹å°±ç”Ÿæˆä»£ç†ï¼Œé‚£ä¹ˆå½“ A å’Œ B å¾ªç¯ä¾èµ–æ—¶ï¼ŒB æ³¨å…¥çš„å¯èƒ½æ˜¯ä¸€ä¸ªâ€œè¿˜æ²¡å‡†å¤‡å¥½çš„ä»£ç†å¯¹è±¡â€ï¼Œè€Œä¸æ˜¯ Spring æƒ³è¦çš„åŠæˆå“åŸå§‹å¯¹è±¡ï¼Œè¿™å¯èƒ½å¯¼è‡´æå‰è°ƒç”¨ä»£ç†é€»è¾‘å‡ºé”™ã€‚

> è¦å›ç­”æ¸…æ¥šï¼Œå¾—åˆ†ä¸¤ä¸ªå±‚æ¬¡ï¼š
>
> ------
>
> ### 1. Spring ç›®å‰çš„è®¾è®¡ï¼ˆä¸ºä»€ä¹ˆæ˜¯åœ¨åˆå§‹åŒ–é˜¶æ®µæ£€æŸ¥æ˜¯å¦éœ€è¦ä»£ç†ï¼‰
>
> Spring çš„ä»£ç†åˆ›å»ºæ˜¯ç”± **`BeanPostProcessor`** å®Œæˆçš„ï¼Œç‰¹åˆ«æ˜¯ `AbstractAutoProxyCreator`ã€‚
>
> - **æ—¶æœº**ï¼š`BeanPostProcessor#postProcessAfterInitialization` â†’ åœ¨ **Bean å®ä¾‹åŒ– + å±æ€§æ³¨å…¥å®Œæˆ** ä¹‹åã€‚
> - **åŸå› **ï¼š
>   1. ä»£ç†é€»è¾‘ä¾èµ–äº **å®Œæ•´çš„ Bean ä¿¡æ¯**ï¼ˆå¦‚ AOP åˆ‡ç‚¹åŒ¹é…ã€äº‹åŠ¡æ³¨è§£ã€@Async ç­‰ï¼‰ï¼Œè¿™äº›å…ƒæ•°æ®æœ‰æ—¶éœ€è¦ä¾èµ–äº **æ³¨å…¥å®Œæˆçš„ä¸Šä¸‹æ–‡**ã€‚
>   2. å¦‚æœè¿‡æ—©åˆ›å»ºä»£ç†ï¼ˆæ¯”å¦‚åœ¨å®ä¾‹åŒ–æ—¶ï¼‰ï¼Œå¯èƒ½ç¼ºå°‘å…³é”®ä¿¡æ¯ï¼Œå¯¼è‡´åŒ¹é…ä¸å‡†ç¡®ã€‚
>
> æ‰€ä»¥ Spring é»˜è®¤åªèƒ½åœ¨åˆå§‹åŒ–é˜¶æ®µå†³å®šæ˜¯å¦åŒ…è£…æˆä»£ç†ã€‚
>  è¿™å°±å¯¼è‡´ï¼š
>
> - å®ä¾‹åŒ–å‡ºæ¥çš„â€œåŠæˆå“â€ Bean åªèƒ½å…ˆæ”¾åˆ° **ä¸‰çº§ç¼“å­˜ï¼ˆObjectFactoryï¼‰**ï¼Œä»¥ä¾¿å¾ªç¯ä¾èµ–æ—¶è¿”å›ã€‚
> - çœŸæ­£çš„ä»£ç†æ›¿æ¢è¦ç­‰åˆ° `postProcessAfterInitialization` æ‰èƒ½å‘ç”Ÿã€‚
>
> ------
>
> ### 2. ä½ æåˆ°çš„æ”¹é€ æ€è·¯ï¼ˆåœ¨åˆ›å»º Bean é˜¶æ®µå°±æ£€æŸ¥ä»£ç†éœ€æ±‚ï¼‰
>
> ç†è®ºä¸Š **æ˜¯å¯è¡Œçš„**ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªå‰æå’Œé—®é¢˜ï¼š
>
> âœ… **å¥½å¤„**ï¼š
>
> - åªéœ€è¦äºŒçº§ç¼“å­˜ï¼ˆä¸ç”¨ ObjectFactory å»¶è¿Ÿä»£ç†ï¼‰ï¼Œå¾ªç¯ä¾èµ–æ—¶å°±èƒ½ç›´æ¥è¿”å›ä»£ç†å¯¹è±¡ã€‚
> - å¯ä»¥å‡å°‘ä¸€å±‚ç¼“å­˜å¸¦æ¥çš„å¤æ‚åº¦ã€‚
>
> âŒ **é—®é¢˜**ï¼š
>
> 1. **å…ƒä¿¡æ¯æ˜¯å¦è¶³å¤Ÿ**
>
>    - å¦‚æœä»£ç†é€»è¾‘åªä¾èµ–äº Bean çš„ **ç±»ä¿¡æ¯ï¼ˆClassï¼‰å’Œ BeanDefinition**ï¼Œé‚£ä¹ˆç¡®å®å¯ä»¥åœ¨å®ä¾‹åŒ–é˜¶æ®µå°±å†³å®šæ˜¯å¦è¦ä»£ç†ã€‚
>    - ä½†æ˜¯å¦‚æœä»£ç†é€»è¾‘ä¾èµ–äº **æ³¨è§£å±æ€§ã€BeanFactory ç¯å¢ƒç”šè‡³ä¾èµ–æ³¨å…¥çš„ç»“æœ**ï¼Œé‚£å®ä¾‹åŒ–å‰ä¸ä¸€å®šèƒ½è·å–å…¨ã€‚
>
>    ğŸ‘‰ ä¸¾ä¸ªä¾‹å­ï¼š
>
>    - `@Transactional` â†’ äº‹åŠ¡ä»£ç†å…¶å®åªéœ€è¦æ–¹æ³•å’Œæ³¨è§£ä¿¡æ¯ï¼Œç†è®ºä¸Šå¯ä»¥æå‰å†³å®šã€‚
>    - `@Async` â†’ ä¹Ÿåªéœ€è¦æ–¹æ³•çº§åˆ«å…ƒæ•°æ®ï¼Œå¯ä»¥æå‰ã€‚
>    - ä½†æ˜¯ä¸€äº›è‡ªå®šä¹‰ `BeanPostProcessor` å¯èƒ½éœ€è¦ Bean åˆå§‹åŒ–åçš„çŠ¶æ€æ¥å†³å®šæ˜¯å¦ä»£ç†ï¼Œé‚£å°±æ²¡æ³•æå‰ã€‚
>
> 2. **å’Œ Spring çš„æ‰©å±•æœºåˆ¶è€¦åˆ**
>     Spring çš„ `BeanPostProcessor` æ˜¯æ’ä»¶åŒ–çš„ï¼Œä½ æ²¡åŠæ³•åœ¨å®ä¾‹åŒ–é˜¶æ®µå°±æå‰çŸ¥é“æ‰€æœ‰åç½®å¤„ç†å™¨çš„é€»è¾‘ï¼ˆé™¤éç¡¬æ”¹ Spring é€»è¾‘ï¼‰ã€‚
>
> 3. **ç”Ÿæ€å…¼å®¹æ€§**
>     ç»å¤§å¤šæ•° Spring ç”Ÿæ€ä¾èµ– `postProcessAfterInitialization` çš„ AOP æ‰©å±•ç‚¹ï¼Œå¦‚æœä½ æ”¹æˆå®ä¾‹åŒ–é˜¶æ®µï¼Œå¾ˆå¤šä¸‰æ–¹åº“å¯èƒ½è¡Œä¸ºå¼‚å¸¸ã€‚
>
> ------
>
> ### 3. ç»“è®º
>
> - **å¦‚æœåªè€ƒè™‘è‡ªå·±é¡¹ç›®çš„ä»£ç†é€»è¾‘**ï¼ˆä¾‹å¦‚åªåŸºäºæ³¨è§£ `@Transactional` / `@Async`ï¼‰ï¼Œå®Œå…¨å¯ä»¥åœ¨ **å®ä¾‹åŒ–é˜¶æ®µ**å°±å†³å®šæ˜¯å¦ä»£ç† â†’ è¿™æ ·å°±èƒ½çœå»ä¸‰çº§ç¼“å­˜ï¼Œç›´æ¥äºŒçº§ç¼“å­˜ä»£ç†å¯¹è±¡ã€‚
> - **ä½†åœ¨ Spring æ¡†æ¶çš„é€šç”¨æœºåˆ¶é‡Œ**ï¼Œç”±äºè¦æ”¯æŒå„ç§ `BeanPostProcessor` å’Œç”Ÿæ€å…¼å®¹ï¼Œæ‰€ä»¥å¿…é¡»ä¿ç•™ä¸‰çº§ç¼“å­˜æœºåˆ¶ã€‚

å…³é”®ç‚¹åœ¨äºï¼š

- **æå‰ä»£ç†åªåœ¨å¾ªç¯ä¾èµ–æ—¶æ‰ä¼šè§¦å‘**ï¼Œå±äºä¸€ç§ã€Œå¦¥åã€æœºåˆ¶ã€‚

- è¿™ç§æƒ…å†µä¸‹ï¼ŒSpring çš„å‡è®¾æ˜¯ï¼š

  > â€œè™½ç„¶ä»£ç†å¯èƒ½ä¸å®Œæ•´ï¼Œä½†æ¯”èµ·æŠ›å‡ºå¼‚å¸¸ï¼ˆæ— æ³•è§£å†³å¾ªç¯ä¾èµ–ï¼‰ï¼Œè¿˜æ˜¯å…ˆç»™ä½ ä¸€ä¸ªä»£ç†å¯¹è±¡é¡¶ç€ç”¨ã€‚â€

ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æ­£å¸¸è·¯å¾„å¿…é¡»ä¿è¯ä»£ç†é€»è¾‘æ˜¯å®Œæ•´çš„ï¼ˆafterInitialization é˜¶æ®µï¼‰**ï¼Œä½†å¾ªç¯ä¾èµ–æ˜¯ä¸ªä¾‹å¤–ã€‚



> ### 4. å¦‚æœæ”¹æˆä½ æè®®çš„ã€Œå®ä¾‹åŒ–é˜¶æ®µå°±ç»Ÿä¸€ä»£ç†ã€
>
> å¥½å¤„ï¼š
>
> - é€»è¾‘æ›´ç®€å•ï¼Œä¸ç”¨ä¸‰çº§ç¼“å­˜äº†ï¼Œç›´æ¥äºŒçº§ç¼“å­˜å­˜ä»£ç†å¯¹è±¡å°±è¡Œã€‚
>
> é£é™©ï¼š
>
> 1. æœ‰äº› `BeanPostProcessor` å¿…é¡»ä¾èµ– **åˆå§‹åŒ–åçš„çŠ¶æ€** æ‰èƒ½å†³å®šæ˜¯å¦ä»£ç†ï¼Œä½ æå‰ç”Ÿæˆå°±ä¼šä¸¢å¤±æ­£ç¡®æ€§ã€‚
> 2. æå‰ä»£ç†ä¼šè¦†ç›–æ‰â€œåˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯èƒ½åŠ¨æ€æ”¹å˜ Bean è¡Œä¸ºâ€çš„åœºæ™¯ï¼ˆæ¯”å¦‚æŸäº›æ¡†æ¶ä¼šåœ¨ init æ–¹æ³•é‡ŒåŠ æ ‡è®°ï¼Œç„¶åæŸä¸ª PostProcessor æ ¹æ®æ ‡è®°å†³å®šæ˜¯å¦åšä»£ç†ï¼‰ã€‚
> 3. Spring ç”Ÿæ€ï¼ˆå¾ˆå¤šä¸‰æ–¹åº“ï¼‰å·²ç»é»˜è®¤ä»£ç†æ—¶æœºæ˜¯ **afterInitialization**ï¼Œä½ æå‰åšå¯èƒ½å¯¼è‡´å…¼å®¹æ€§é—®é¢˜ã€‚
>
> ------
>
> ### 5. æ€»ç»“
>
> - **ç°åœ¨çš„è®¾è®¡**ï¼š
>   - é»˜è®¤åœ¨ **åˆå§‹åŒ–å®Œæˆå** å†å†³å®šæ˜¯å¦ä»£ç†ï¼ˆä¿è¯å‡†ç¡®æ€§ï¼‰ã€‚
>   - å¾ªç¯ä¾èµ–æ—¶ï¼Œå…è®¸â€œæå‰ä»£ç†â€ä½œä¸ºç‰¹ä¾‹ï¼ˆä¿è¯å¯ç”¨æ€§ï¼‰ã€‚
> - **ä½ çš„æ€è·¯**ï¼š
>   - å¦‚æœåœºæ™¯å•ä¸€ã€å¯æ§ï¼ˆæ¯”å¦‚åªä¾èµ–æ³¨è§£ä¿¡æ¯ï¼Œä¸ä¾èµ–åˆå§‹åŒ–çŠ¶æ€ï¼‰ï¼Œå¯ä»¥åœ¨å®ä¾‹åŒ–é˜¶æ®µå°±ä»£ç†ï¼Œä»è€Œç®€åŒ–ç¼“å­˜ç»“æ„ã€‚
>   - ä½†é€šç”¨æ¡†æ¶å±‚é¢ï¼Œå¿…é¡»ä¿ç•™ä¸‰çº§ç¼“å­˜ï¼Œå› ä¸ºæœ‰å¤ªå¤šæ‰©å±•ç‚¹éœ€è¦ **åˆå§‹åŒ–å®Œæˆåçš„ä¿¡æ¯**ã€‚

Spring æ€ä¹ˆç¼“å’Œ / è§£å†³ä»£ç†ä¸å®Œæ•´è¿™ä¸ªé—®é¢˜

> **ä¿ç•™ `postProcessAfterInitialization` æµç¨‹**
>
> - å³ä½¿æ—©æœŸè¿”å›äº†ä»£ç†ï¼ŒSpring ä»ç„¶ä¼šåœ¨è¯¥ Bean åç»­å®Œæˆåˆå§‹åŒ–æ—¶èµ° `postProcessAfterInitialization`ã€‚
> - ä½† `AbstractAutoProxyCreator` å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡è®°ï¼ˆä¾‹å¦‚ `earlyProxyReferences`ï¼‰ï¼Œè®°å½•å“ªäº› Bean å·²ç»è¢«æå‰ä»£ç†è¿‡ã€‚`postProcessAfterInitialization` åœ¨çœ‹åˆ°è¯¥æ ‡è®°åé€šå¸¸**ä¸ä¼šå†åˆ›å»ºæ–°çš„ä»£ç†**ï¼Œä»¥é¿å…é‡å¤åŒ…è£…ï¼ˆåŒé‡ä»£ç†ï¼‰ã€‚

------

### Springçš„äº‹åŠ¡ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¤±æ•ˆï¼Ÿ

è™½ç„¶è§£å†³äº†å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œä½†å…¶å®æˆ‘ä»¬çš„æ”¹é€ å´åŸ‹ä¸‹äº†å¦ä¸€ä¸ªéšæ‚£ã€‚ä¸€èµ·æµ‹è¯•ä¸€ä¸‹ã€‚

æˆ‘ä»¬åœ¨é¢†åˆ¸ä¸šåŠ¡çš„æœ€åæ•…æ„æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼š

![img](https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTA2MTA3NmNmNDYwOTFmM2MwZTNiZWQ5NTM0NDJiMmZfRndETDg5VW53S2xqVkFtcXN6M2FralhPUHdHakVXOVNfVG9rZW46QTRvWGJuQ2lVb2ZuMmd4bGFib2NsT3FubllmXzE3NTc1NTQyOTQ6MTc1NzU1Nzg5NF9WNA)

ç»è¿‡æµ‹è¯•ï¼Œå‘ç°è™½ç„¶æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä½†æ˜¯åº“å­˜ã€ç”¨æˆ·åˆ¸éƒ½æ²¡æœ‰å›æ»šï¼äº‹åŠ¡å¤±æ•ˆäº†ï¼

#### 3.4.1.1.äº‹åŠ¡æ–¹æ³•épublicä¿®é¥°

ç”±äºSpringçš„äº‹åŠ¡æ˜¯åŸºäºAOPçš„æ–¹å¼ç»“åˆåŠ¨æ€ä»£ç†æ¥å®ç°çš„ã€‚å› æ­¤äº‹åŠ¡æ–¹æ³•ä¸€å®šè¦æ˜¯publicçš„ï¼Œè¿™æ ·æ‰èƒ½ä¾¿äºè¢«Springåšäº‹åŠ¡çš„ä»£ç†å’Œå¢å¼ºã€‚

è€Œä¸”ï¼Œåœ¨Springå†…éƒ¨ä¹Ÿä¼šæœ‰ä¸€ä¸ª `org.springframework.transaction.interceptor.AbstractFallbackTransactionAttributeSource`ç±»ï¼Œå»æ£€æŸ¥äº‹åŠ¡æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼š

```Java
@Nullable
 protected TransactionAttribute computeTransactionAttribute(
  Method method, @Nullable Class<?> targetClass) {
   // Don't allow non-public methods, as configured.
   if (allowPublicMethodsOnly() && 
  !Modifier.isPublic(method.getModifiers())) {
      return null;
   }

    // ... ç•¥

   return null;
 }
```

æ‰€ä»¥ï¼Œäº‹åŠ¡æ–¹æ³•ä¸€å®šè¦è¢«publicä¿®é¥°ï¼

#### 3.4.1.2.éäº‹åŠ¡æ–¹æ³•è°ƒç”¨äº‹åŠ¡æ–¹æ³•

æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š

```Java
@Service
public class OrderService {
    
    public void createOrder(){
        // ... å‡†å¤‡è®¢å•æ•°æ®
        
        // ç”Ÿæˆè®¢å•å¹¶æ‰£å‡åº“å­˜
        insertOrderAndReduceStock();
    }
    
    @Transactional
    public void insertOrderAndReduceStock(){
        // ç”Ÿæˆè®¢å•
        insertOrder();
        // æ‰£å‡åº“å­˜
        reduceStock();
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ`insertOrderAndReduceStock`æ–¹æ³•æ˜¯ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ï¼Œè‚¯å®šä¼šè¢«Springäº‹åŠ¡ç®¡ç†ã€‚Springä¼šç»™`OrderService`ç±»ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œå¯¹`insertOrderAndReduceStock`æ–¹æ³•åšå¢åŠ ï¼Œå®ç°äº‹åŠ¡æ•ˆæœã€‚

ä½†æ˜¯ç°åœ¨`createOrder`æ–¹æ³•æ˜¯ä¸€ä¸ªéäº‹åŠ¡æ–¹æ³•ï¼Œåœ¨å…¶ä¸­è°ƒç”¨äº†`insertOrderAndReduceStock`æ–¹æ³•ï¼Œè¿™ä¸ªè°ƒç”¨å…¶å®éšå«äº†ä¸€ä¸ª`this.`çš„å‰ç¼€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œç›¸å½“äºæ˜¯ç›´æ¥è°ƒç”¨åŸå§‹çš„OrderServiceä¸­çš„æ™®é€šæ–¹æ³•ï¼Œè€Œéè¢«Springä»£ç†å¯¹è±¡çš„ä»£ç†æ–¹æ³•ã€‚é‚£äº‹åŠ¡è‚¯å®šå°±å¤±æ•ˆäº†ï¼

#### 3.4.1.3.äº‹åŠ¡æ–¹æ³•çš„å¼‚å¸¸è¢«æ•è·äº†

ç¤ºä¾‹ï¼š

```Java
 @Service
 public class OrderService {

    @Transactional
    public void createOrder(){
        // ... å‡†å¤‡è®¢å•æ•°æ®
        // ç”Ÿæˆè®¢å•
        insertOrder();
        // æ‰£å‡åº“å­˜
        reduceStock();
    }

    private void reduceStock() {
        try {
            // ...æ‰£åº“å­˜
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
        }
    }

 }
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼ŒreduceStockæ–¹æ³•å†…éƒ¨ç›´æ¥æ•è·äº†Exceptionç±»å‹çš„å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å³ä¾¿å‡ºç°äº†å¼‚å¸¸ä¹Ÿä¸ä¼šå‘å¤–æŠ›å‡ºã€‚

è€ŒSpringçš„äº‹åŠ¡ç®¡ç†å°±æ˜¯è¦æ„ŸçŸ¥ä¸šåŠ¡æ–¹æ³•çš„å¼‚å¸¸ï¼Œå½“æ•è·åˆ°å¼‚å¸¸åæ‰ä¼šå›æ»šäº‹åŠ¡ã€‚

ç°åœ¨äº‹åŠ¡è¢«æ•è·ï¼Œå°±ä¼šå¯¼è‡´Springæ— æ³•æ„ŸçŸ¥äº‹åŠ¡å¼‚å¸¸ï¼Œè‡ªç„¶ä¸ä¼šå›æ»šï¼Œäº‹åŠ¡å°±å¤±æ•ˆäº†ã€‚

#### 3.4.1.4.äº‹åŠ¡å¼‚å¸¸ç±»å‹ä¸å¯¹

ç¤ºä¾‹ä»£ç ï¼š

```Java
@Service
 public class OrderService {

    @Transactional(rollbackFor = RuntimeException.class)
    public void createOrder() throws IOException {
        // ... å‡†å¤‡è®¢å•æ•°æ®
        
        // ç”Ÿæˆè®¢å•
        insertOrder();
        // æ‰£å‡åº“å­˜
        reduceStock();

        throw new IOException();
    }
 }
```

Springçš„äº‹åŠ¡ç®¡ç†é»˜è®¤æ„ŸçŸ¥çš„å¼‚å¸¸ç±»å‹æ˜¯`RuntimeException`ï¼Œå½“äº‹åŠ¡æ–¹æ³•å†…éƒ¨æŠ›å‡ºäº†ä¸€ä¸ª`IOException`æ—¶ï¼Œä¸ä¼šè¢«Springæ•è·ï¼Œå› æ­¤å°±ä¸ä¼šè§¦å‘äº‹åŠ¡å›æ»šï¼Œäº‹åŠ¡å°±å¤±æ•ˆäº†ã€‚

å› æ­¤ï¼Œå½“æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­ä¼šæŠ›å‡ºRuntimeExceptionä»¥å¤–çš„å¼‚å¸¸æ—¶ï¼Œåº”è¯¥é€šè¿‡`@Transactional`æ³¨è§£ä¸­çš„`rollbackFor`å±æ€§æ¥æŒ‡å®šå¼‚å¸¸ç±»å‹ï¼š

```Java
@Transactional(rollbackFor = Exception.class)
```

#### 3.4.1.5.äº‹åŠ¡ä¼ æ’­è¡Œä¸ºä¸å¯¹

ç¤ºä¾‹ä»£ç ï¼š

```Java
@Service
 public class OrderService {
    @Transactional
    public void createOrder(){
        // ç”Ÿæˆè®¢å•
        insertOrder();
        // æ‰£å‡åº“å­˜
        reduceStock();
        throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
    }
    @Transactional
    public void insertOrder() {
    }
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void reduceStock() {
    }
 }
```

åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œäº‹åŠ¡çš„å…¥å£æ˜¯`createOrder()`æ–¹æ³•ï¼Œä¼šå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå¯ä»¥æˆä¸ºå¤–éƒ¨äº‹åŠ¡ã€‚åœ¨createOrder()æ–¹æ³•å†…éƒ¨åˆè°ƒç”¨äº†`insertOrder()`æ–¹æ³•å’Œ`reduceStock()`æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªéƒ½æ˜¯äº‹åŠ¡æ–¹æ³•ã€‚

ä¸è¿‡ï¼Œ`reduceStock()`æ–¹æ³•çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯`REQUIRES_NEW`ï¼Œè¿™ä¼šå¯¼è‡´åœ¨è¿›å…¥`reduceStock()`æ–¹æ³•æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¯ä»¥æˆä¸ºå­äº‹åŠ¡ã€‚`insertOrder()`åˆ™æ˜¯é»˜è®¤ï¼Œå› æ­¤ä¼šä¸`createOrder()`åˆå¹¶äº‹åŠ¡ã€‚

å› æ­¤ï¼Œå½“`createOrder`æ–¹æ³•æœ€åæŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œåªä¼šå¯¼è‡´`insertOrder`æ–¹æ³•å›æ»šï¼Œè€Œä¸ä¼šå¯¼è‡´`reduceStock`æ–¹æ³•å›æ»šï¼Œå› ä¸º`reduceStock`æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ã€‚

æ‰€ä»¥ï¼Œä¸€å®šè¦æ…ç”¨ä¼ æ’­è¡Œä¸ºï¼Œæ³¨æ„å¤–éƒ¨äº‹åŠ¡ä¸å†…éƒ¨äº‹åŠ¡ä¹‹é—´çš„å…³ç³»ã€‚

#### 3.4.1.6.æ²¡æœ‰è¢«Springç®¡ç†

ç¤ºä¾‹ä»£ç ï¼š

```Java
//  @Service
 public class OrderService {
    @Transactional
    public void createOrder(){
        // ç”Ÿæˆè®¢å•
        insertOrder();
        // æ‰£å‡åº“å­˜
        reduceStock();
        throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
    }
    @Transactional
    public void insertOrder() {
    }
    @Transactional
    public void reduceStock() {
    }
 }
```

è¿™ä¸ªç¤ºä¾‹å±äºæ¯”è¾ƒä½çº§çš„é”™è¯¯ï¼Œ`OrderService`ç±»æ²¡æœ‰æ·»åŠ `@Service`æ³¨è§£ï¼Œå› æ­¤å°±æ²¡æœ‰è¢«Springç®¡ç†ã€‚ä½ åœ¨æ–¹æ³•ä¸Šæ·»åŠ çš„`@Transactional`æ³¨è§£æ ¹æœ¬ä¸ä¼šæœ‰äººå¸®ä½ åŠ¨æ€ä»£ç†ï¼Œäº‹åŠ¡è‡ªç„¶å¤±æ•ˆã€‚

å½“ç„¶ï¼Œæœ‰åŒå­¦ä¼šè¯´ï¼Œæˆ‘ä¸ä¼šçŠ¯è¿™ä¹ˆä½çº§çš„é”™è¯¯ã€‚è¿™å¯ä¸ä¸€å®šï¼Œæœ‰çš„æ—¶å€™ä½ æ²¡æœ‰å¿˜äº†åŠ `@Service`æ³¨è§£ï¼Œä½†æ˜¯ä½ åœ¨è·å–æŸä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå¯èƒ½å¹¶ä¸æ˜¯è·å–çš„Springç®¡ç†çš„å¯¹è±¡ï¼Œæœ‰å¯èƒ½æ˜¯å…¶å®ƒæ–¹å¼åˆ›å»ºçš„ã€‚è¿™åŒæ ·ä¼šå¯¼è‡´äº‹åŠ¡å¤±æ•ˆã€‚

------

### Beançš„ç”Ÿå‘½å‘¨æœŸè¯´ä¸€ä¸‹ï¼Ÿ

![img](https://cdn.xiaolincoding.com//picgo/1719570477922-ad595a67-be98-4272-9e13-8ad73dd75c13.png)

1. Springå¯åŠ¨ï¼ŒæŸ¥æ‰¾å¹¶åŠ è½½éœ€è¦è¢«Springç®¡ç†çš„beanï¼Œè¿›è¡ŒBeançš„å®ä¾‹åŒ–
2. Beanå®ä¾‹åŒ–åå¯¹å°†Beançš„å¼•å…¥å’Œå€¼æ³¨å…¥åˆ°Beançš„å±æ€§ä¸­
3. å¦‚æœBeanå®ç°äº†BeanNameAwareæ¥å£çš„è¯ï¼ŒSpringå°†Beançš„Idä¼ é€’ç»™setBeanName()æ–¹æ³•
4. å¦‚æœBeanå®ç°äº†BeanFactoryAwareæ¥å£çš„è¯ï¼ŒSpringå°†è°ƒç”¨setBeanFactory()æ–¹æ³•ï¼Œå°†BeanFactoryå®¹å™¨å®ä¾‹ä¼ å…¥
5. å¦‚æœBeanå®ç°äº†ApplicationContextAwareæ¥å£çš„è¯ï¼ŒSpringå°†è°ƒç”¨Beançš„setApplicationContext()æ–¹æ³•ï¼Œå°†beanæ‰€åœ¨åº”ç”¨ä¸Šä¸‹æ–‡å¼•ç”¨ä¼ å…¥è¿›æ¥ã€‚
6. å¦‚æœBeanå®ç°äº†BeanPostProcessoræ¥å£ï¼ŒSpringå°±å°†è°ƒç”¨ä»–ä»¬çš„postProcessBeforeInitialization()æ–¹æ³•ã€‚
7. å¦‚æœBean å®ç°äº†InitializingBeanæ¥å£ï¼ŒSpringå°†è°ƒç”¨ä»–ä»¬çš„afterPropertiesSet()æ–¹æ³•ã€‚ç±»ä¼¼çš„ï¼Œå¦‚æœbeanä½¿ç”¨init-methodå£°æ˜äº†åˆå§‹åŒ–æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨
8. å¦‚æœBean å®ç°äº†BeanPostProcessoræ¥å£ï¼ŒSpringå°±å°†è°ƒç”¨ä»–ä»¬çš„postProcessAfterInitialization()æ–¹æ³•ã€‚
9. æ­¤æ—¶ï¼ŒBeanå·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¢«åº”ç”¨ç¨‹åºä½¿ç”¨äº†ã€‚ä»–ä»¬å°†ä¸€ç›´é©»ç•™åœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­ï¼Œç›´åˆ°åº”ç”¨ä¸Šä¸‹æ–‡è¢«é”€æ¯ã€‚
10. å¦‚æœbeanå®ç°äº†DisposableBeanæ¥å£ï¼ŒSpringå°†è°ƒç”¨å®ƒçš„destory()æ¥å£æ–¹æ³•ï¼ŒåŒæ ·ï¼Œå¦‚æœbeanä½¿ç”¨äº†destory-method å£°æ˜é”€æ¯æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚

------

### Beanæ˜¯å¦å•ä¾‹ï¼Ÿ

Spring ä¸­çš„ Bean ==é»˜è®¤éƒ½æ˜¯å•ä¾‹çš„==ã€‚

å°±æ˜¯è¯´ï¼Œæ¯ä¸ªBeançš„å®ä¾‹åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ï¼Œå¹¶ä¸”ä¼šè¢«å­˜å‚¨åœ¨Springå®¹å™¨çš„ç¼“å­˜ä¸­ï¼Œä»¥ä¾¿åœ¨åç»­çš„è¯·æ±‚ä¸­é‡å¤ä½¿ç”¨ã€‚è¿™ç§å•ä¾‹æ¨¡å¼å¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå†…å­˜æ•ˆç‡ã€‚

ä½†æ˜¯ï¼ŒSpringä¹Ÿæ”¯æŒå°†Beanè®¾ç½®ä¸ºå¤šä¾‹æ¨¡å¼ï¼Œå³æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Beanå®ä¾‹ã€‚è¦å°†Beanè®¾ç½®ä¸ºå¤šä¾‹æ¨¡å¼ï¼Œ==å¯ä»¥åœ¨Beanå®šä¹‰ä¸­é€šè¿‡è®¾ç½®scopeå±æ€§ä¸º"prototype"æ¥å®ç°ã€‚==

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶Springçš„é»˜è®¤è¡Œä¸ºæ˜¯å°†Beanè®¾ç½®ä¸ºå•ä¾‹æ¨¡å¼ï¼Œä½†åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¤šä¾‹æ¨¡å¼æ˜¯æ›´ä¸ºåˆé€‚çš„ï¼Œä¾‹å¦‚åœ¨åˆ›å»ºçŠ¶æ€ä¸å¯å˜çš„Beanæˆ–æœ‰çŠ¶æ€Beanæ—¶ã€‚æ­¤å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœBeanå•ä¾‹æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨æ—¶éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ã€‚

------

### Beançš„å•ä¾‹å’Œéå•ä¾‹ï¼Œç”Ÿå‘½å‘¨æœŸæ˜¯å¦ä¸€æ ·

ä¸ä¸€æ ·çš„ï¼ŒSpring Bean çš„ç”Ÿå‘½å‘¨æœŸå®Œå…¨ç”± IoC å®¹å™¨æ§åˆ¶ã€‚==Spring åªå¸®æˆ‘ä»¬ç®¡ç†å•ä¾‹æ¨¡å¼ Bean çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ==ï¼Œå¯¹äº `prototype` çš„ Beanï¼ŒSpring åœ¨åˆ›å»ºå¥½äº¤ç»™ä½¿ç”¨è€…ä¹‹åï¼Œåˆ™ä¸ä¼šå†ç®¡ç†åç»­çš„ç”Ÿå‘½å‘¨æœŸã€‚

å…·ä½“åŒºåˆ«å¦‚ä¸‹ï¼š

| **é˜¶æ®µ**       | **å•ä¾‹ï¼ˆSingletonï¼‰**                                       | **éå•ä¾‹ï¼ˆå¦‚Prototypeï¼‰**                                    |
| :------------- | :---------------------------------------------------------- | :----------------------------------------------------------- |
| **åˆ›å»ºæ—¶æœº**   | å®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºï¼ˆæˆ–é¦–æ¬¡è¯·æ±‚æ—¶ï¼Œå–å†³äºé…ç½®ï¼‰ã€‚                | æ¯æ¬¡è¯·æ±‚æ—¶åˆ›å»ºæ–°å®ä¾‹ã€‚                                       |
| **åˆå§‹åŒ–æµç¨‹** | å®Œæ•´æ‰§è¡Œç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼ˆå±æ€§æ³¨å…¥ã€Awareæ¥å£ã€åˆå§‹åŒ–æ–¹æ³•ç­‰ï¼‰ã€‚ | æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹æ—¶éƒ½ä¼šå®Œæ•´æ‰§è¡Œç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼ˆä»…åˆ°åˆå§‹åŒ–å®Œæˆï¼‰ã€‚ |
| **é”€æ¯æ—¶æœº**   | å®¹å™¨å…³é—­æ—¶é”€æ¯ï¼Œè§¦å‘`DisposableBean`æˆ–`destroy-method`ã€‚    | **å®¹å™¨ä¸ç®¡ç†é”€æ¯**ï¼Œéœ€ç”±è°ƒç”¨è€…è‡ªè¡Œé‡Šæ”¾èµ„æºï¼ˆSpringä¸è·Ÿè¸ªå®ä¾‹ï¼‰ã€‚ |
| **å†…å­˜å ç”¨**   | å•å®ä¾‹å¸¸é©»å†…å­˜ï¼Œé«˜æ•ˆä½†éœ€æ³¨æ„çº¿ç¨‹å®‰å…¨ã€‚                      | æ¯æ¬¡è¯·æ±‚ç”Ÿæˆæ–°å®ä¾‹ï¼Œå†…å­˜å¼€é”€è¾ƒå¤§ï¼Œéœ€æ‰‹åŠ¨ç®¡ç†èµ„æºé‡Šæ”¾ã€‚       |
| **é€‚ç”¨åœºæ™¯**   | æ— çŠ¶æ€æœåŠ¡ï¼ˆå¦‚Serviceã€DAOå±‚ï¼‰ã€‚                            | æœ‰çŠ¶æ€å¯¹è±¡ï¼ˆå¦‚ç”¨æˆ·ä¼šè¯ã€ä¸´æ—¶è®¡ç®—å¯¹è±¡ï¼‰ã€‚                     |

==å•ä¾‹ç”Ÿå‘½å‘¨æœŸè·ŸéšIOCå³ä½¿æ²¡æœ‰è¢«å¤–éƒ¨å¼•ç”¨ä¹Ÿä¸ä¼šè¢«gcå¤„ç†ï¼Œéå•ä¾‹Beanå¯ä»¥è¢«gcå¤„ç†ï¼Œä½†è¦æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•é‡Šæ”¾èµ„æº==

------

### Spring beançš„ä½œç”¨åŸŸæœ‰å“ªäº›ï¼Ÿ

Springæ¡†æ¶ä¸­çš„Beanä½œç”¨åŸŸï¼ˆScopeï¼‰å®šä¹‰äº†Beançš„ç”Ÿå‘½å‘¨æœŸå’Œå¯è§æ€§ã€‚ä¸åŒçš„ä½œç”¨åŸŸå½±å“ç€Springå®¹å™¨å¦‚ä½•ç®¡ç†è¿™äº›Beançš„å®ä¾‹ï¼ŒåŒ…æ‹¬å®ƒä»¬å¦‚ä½•è¢«åˆ›å»ºã€å¦‚ä½•è¢«é”€æ¯ä»¥åŠå®ƒä»¬æ˜¯å¦å¯ä»¥è¢«å¤šä¸ªç”¨æˆ·å…±äº«ã€‚

Springæ”¯æŒå‡ ç§ä¸åŒçš„ä½œç”¨åŸŸï¼Œä»¥æ»¡è¶³ä¸åŒçš„åº”ç”¨åœºæ™¯éœ€æ±‚ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦çš„Beanä½œç”¨åŸŸï¼š

- **Singletonï¼ˆå•ä¾‹ï¼‰**ï¼šåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­åªå­˜åœ¨ä¸€ä¸ª Bean å®ä¾‹ã€‚é»˜è®¤ä½œç”¨åŸŸï¼ŒSpring å®¹å™¨ä¸­åªä¼šåˆ›å»ºä¸€ä¸ª Bean å®ä¾‹ï¼Œå¹¶åœ¨å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å…±äº«è¯¥å®ä¾‹ã€‚
- **Prototypeï¼ˆåŸå‹ï¼‰**ï¼šæ¯æ¬¡è¯·æ±‚æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Bean å®ä¾‹ã€‚æ¬¡ä»å®¹å™¨ä¸­è·å–è¯¥ Bean æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ï¼Œé€‚ç”¨äºçŠ¶æ€éå¸¸ç¬æ—¶çš„ Beanã€‚
- **Requestï¼ˆè¯·æ±‚ï¼‰**ï¼šæ¯ä¸ª HTTP è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Bean å®ä¾‹ã€‚ä»…åœ¨ Spring Web åº”ç”¨ç¨‹åºä¸­æœ‰æ•ˆï¼Œæ¯ä¸ª HTTP è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Bean å®ä¾‹ï¼Œé€‚ç”¨äº Web åº”ç”¨ä¸­éœ€æ±‚å±€éƒ¨æ€§çš„ Beanã€‚
- **Sessionï¼ˆä¼šè¯ï¼‰**ï¼šSession èŒƒå›´å†…åªä¼šåˆ›å»ºä¸€ä¸ª Bean å®ä¾‹ã€‚è¯¥ Bean å®ä¾‹åœ¨ç”¨æˆ·ä¼šè¯èŒƒå›´å†…å…±äº«ï¼Œä»…åœ¨ Spring Web åº”ç”¨ç¨‹åºä¸­æœ‰æ•ˆï¼Œé€‚ç”¨äºä¸ç”¨æˆ·ä¼šè¯ç›¸å…³çš„ Beanã€‚
- **Application**ï¼šå½“å‰ ServletContext ä¸­åªå­˜åœ¨ä¸€ä¸ª Bean å®ä¾‹ã€‚ä»…åœ¨ Spring Web åº”ç”¨ç¨‹åºä¸­æœ‰æ•ˆï¼Œè¯¥ Bean å®ä¾‹åœ¨æ•´ä¸ª ServletContext èŒƒå›´å†…å…±äº«ï¼Œé€‚ç”¨äºåº”ç”¨ç¨‹åºèŒƒå›´å†…å…±äº«çš„ Beanã€‚
- **WebSocketï¼ˆWebå¥—æ¥å­—ï¼‰**ï¼šåœ¨ WebSocket èŒƒå›´å†…åªå­˜åœ¨ä¸€ä¸ª Bean å®ä¾‹ã€‚ä»…åœ¨æ”¯æŒ WebSocket çš„åº”ç”¨ç¨‹åºä¸­æœ‰æ•ˆï¼Œè¯¥ Bean å®ä¾‹åœ¨ WebSocket ä¼šè¯èŒƒå›´å†…å…±äº«ï¼Œé€‚ç”¨äº WebSocket ä¼šè¯èŒƒå›´å†…å…±äº«çš„ Beanã€‚
- **Custom scopesï¼ˆè‡ªå®šä¹‰ä½œç”¨åŸŸï¼‰**ï¼šSpring å…è®¸å¼€å‘è€…å®šä¹‰è‡ªå®šä¹‰çš„ä½œç”¨åŸŸï¼Œé€šè¿‡å®ç° Scope æ¥å£æ¥åˆ›å»ºæ–°çš„ Bean ä½œç”¨åŸŸã€‚

åœ¨Springé…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é€šè¿‡`<bean>`æ ‡ç­¾çš„scopeå±æ€§æ¥æŒ‡å®šBeançš„ä½œç”¨åŸŸã€‚ä¾‹å¦‚ï¼š

```xml
<bean id="myBean" class="com.example.MyBeanClass" scope="singleton"/>
```

åœ¨Spring Bootæˆ–åŸºäºJavaçš„é…ç½®ä¸­ï¼Œå¯ä»¥é€šè¿‡@Scopeæ³¨è§£æ¥æŒ‡å®šBeançš„ä½œç”¨åŸŸã€‚ä¾‹å¦‚ï¼š

```java
@Bean  
@Scope("prototype")  
public MyBeanClass myBean() {  
    return new MyBeanClass();  
}
```

> ------
>
> ## 1. **Sessionï¼ˆä¼šè¯ä½œç”¨åŸŸï¼‰**
>
> - **ç‰¹å¾**ï¼šåŒä¸€ä¸ªç”¨æˆ·ä¼šè¯ï¼ˆSessionï¼‰é‡Œå…±äº«ä¸€ä¸ª Beanï¼Œä¸åŒç”¨æˆ·ä¹‹é—´äº’ä¸å½±å“ã€‚
> - **åº”ç”¨åœºæ™¯**ï¼šç”¨æˆ·ç›¸å…³çš„ä¸´æ—¶æ•°æ®ï¼Œä¾‹å¦‚è´­ç‰©è½¦ã€ç”¨æˆ·åå¥½ã€è¡¨å•å‘å¯¼ã€‚
>
> ### ç¤ºä¾‹ï¼šè´­ç‰©è½¦
>
> ```java
> @Component
> @Scope(value = WebApplicationContext.SCOPE_SESSION, proxyMode = ScopedProxyMode.TARGET_CLASS)
> public class ShoppingCart {
>     private final List<String> items = new ArrayList<>();
>     public void addItem(String item) { items.add(item); }
>     public List<String> getItems() { return items; }
> }
> ```
>
> - ç”¨æˆ· A çš„è´­ç‰©è½¦é‡Œæ˜¯ `["Apple", "Banana"]`
> - ç”¨æˆ· B çš„è´­ç‰©è½¦é‡Œæ˜¯ `[]`
> - **è¯´æ˜ï¼šæ¯ä¸ª Session ä¸€ä¸ªç‹¬ç«‹ Bean å®ä¾‹**
>
> ------
>
> ## 2. **Applicationï¼ˆåº”ç”¨ä½œç”¨åŸŸï¼‰**
>
> - **ç‰¹å¾**ï¼šæ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ª Bean å®ä¾‹ï¼Œå­˜æ´»äº `ServletContext` èŒƒå›´ï¼Œæ‰€æœ‰è¯·æ±‚å…±äº«ã€‚
> - **åº”ç”¨åœºæ™¯**ï¼šå…¨å±€é…ç½®ã€ç¼“å­˜ã€ç»Ÿè®¡ä¿¡æ¯ã€‚
>
> ### ç¤ºä¾‹ï¼šè®¿é—®ç»Ÿè®¡å™¨
>
> ```java
> @Component
> @Scope(value = WebApplicationContext.SCOPE_APPLICATION, proxyMode = ScopedProxyMode.TARGET_CLASS)
> public class AppStatistics {
>     private final AtomicInteger counter = new AtomicInteger();
>     public int increment() { return counter.incrementAndGet(); }
> }
> ```
>
> - æ‰€æœ‰ç”¨æˆ·çš„è¯·æ±‚éƒ½ä¼šå…±äº«åŒä¸€ä¸ª `AppStatistics` Beanã€‚
> - æ¯”å¦‚ï¼š
>   - ç”¨æˆ· A è®¿é—® â†’ è®¡æ•°å™¨=1
>   - ç”¨æˆ· B è®¿é—® â†’ è®¡æ•°å™¨=2
>   - ç”¨æˆ· C è®¿é—® â†’ è®¡æ•°å™¨=3
>
> ------
>
> ## 3. **WebSocketï¼ˆWebSocket ä½œç”¨åŸŸï¼‰**
>
> - **ç‰¹å¾**ï¼šåœ¨æ¯ä¸ª WebSocket è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸå†…åˆ›å»ºä¸€ä¸ª Beanï¼Œæ¯æ¡è¿æ¥ç‹¬ç«‹ã€‚
> - **åº”ç”¨åœºæ™¯**ï¼šå®æ—¶é€šä¿¡ä¼šè¯æ•°æ®ï¼Œæ¯”å¦‚èŠå¤©å®¤é‡Œæ¯ä¸ªç”¨æˆ·çš„ä¸Šä¸‹æ–‡ã€‚
>
> ### ç¤ºä¾‹ï¼šèŠå¤©ä¼šè¯ä¸Šä¸‹æ–‡
>
> ```java
> @Component
> @Scope(value = "websocket", proxyMode = ScopedProxyMode.TARGET_CLASS)
> public class ChatSessionContext {
>     private String username;
>     private final List<String> messages = new ArrayList<>();
>     // getter & setter
> }
> ```
>
> - ç”¨æˆ· A å»ºç«‹ WebSocket è¿æ¥ â†’ æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ `ChatSessionContext`ã€‚
> - ç”¨æˆ· B è¿æ¥ â†’ æ‹¥æœ‰è‡ªå·±çš„ `ChatSessionContext`ï¼Œäº’ä¸å¹²æ‰°ã€‚
> - å½“ WebSocket å…³é—­æ—¶ï¼ŒBean ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚
>
> ------
>
> ## 4. **Custom Scopesï¼ˆè‡ªå®šä¹‰ä½œç”¨åŸŸï¼‰**
>
> - **ç‰¹å¾**ï¼šä½ å¯ä»¥å®ç° `Scope` æ¥å£ï¼Œå®Œå…¨è‡ªå®šä¹‰ Bean çš„ç”Ÿå‘½å‘¨æœŸã€‚
> - **åº”ç”¨åœºæ™¯**ï¼šä¾‹å¦‚ã€Œæ¯æ¬¡ä¸šåŠ¡äº‹åŠ¡ã€ã€ã€Œæ¯æ¬¡ API è°ƒç”¨ã€ã€ã€Œç§Ÿæˆ·éš”ç¦»ã€ç­‰ç‰¹æ®Šéœ€æ±‚ã€‚
>
> ### ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ªâ€œè¯·æ±‚ç”¨æˆ·çº§åˆ«â€çš„ä½œç”¨åŸŸ
>
> æ¯”å¦‚æˆ‘ä»¬å¸Œæœ›åœ¨ **å½“å‰è¯·æ±‚çš„ç”¨æˆ·ä¸Šä¸‹æ–‡** ä¸­å…±äº«ä¸€ä¸ª Beanï¼Œè€Œä¸æ˜¯æ•´ä¸ª Sessionï¼š
>
> ```java
> public class UserScope implements Scope {
>     private final ThreadLocal<Map<String, Object>> beans = ThreadLocal.withInitial(HashMap::new);
> 
>     @Override
>     public Object get(String name, ObjectFactory<?> objectFactory) {
>         return beans.get().computeIfAbsent(name, k -> objectFactory.getObject());
>     }
>     @Override public Object remove(String name) { return beans.get().remove(name); }
>     @Override public void registerDestructionCallback(String name, Runnable callback) {}
>     @Override public Object resolveContextualObject(String key) { return null; }
>     @Override public String getConversationId() { return Thread.currentThread().getName(); }
> }
> ```
>
> ç„¶åæ³¨å†Œè‡ªå®šä¹‰ scopeï¼š
>
> ```java
> @Configuration
> public class ScopeConfig {
>     @Bean
>     public static CustomScopeConfigurer configurer() {
>         CustomScopeConfigurer configurer = new CustomScopeConfigurer();
>         configurer.addScope("user", new UserScope());
>         return configurer;
>     }
> }
> ```
>
> å†ä½¿ç”¨ï¼š
>
> ```java
> @Component
> @Scope("user")
> public class UserContext {
>     private String username;
>     // ...
> }
> ```
>
> Bean çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ° **ç”¨æˆ· ID**ï¼Œè€Œä¸æ˜¯çº¿ç¨‹ã€‚
>
> è¿™æ ·å°±å¯ä»¥çµæ´»å®ç° **æŒ‰ç”¨æˆ·ç»´åº¦** çš„ Bean ç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸æ˜¯ç»‘å®šåœ¨æ ‡å‡†çš„ Session æˆ– Application ä¸Šã€‚
>
> ------
>
> ğŸ“Œ æ€»ç»“å¯¹æ¯”ï¼š
>
> - **Session**ï¼šæ¯ä¸ªç”¨æˆ·ä¼šè¯ç‹¬ç«‹ï¼ˆå¦‚è´­ç‰©è½¦ï¼‰ã€‚
> - **Application**ï¼šå…¨åº”ç”¨å…±äº«ä¸€ä¸ªï¼ˆå¦‚å…¨å±€ç»Ÿè®¡å™¨ï¼‰ã€‚
> - **WebSocket**ï¼šæ¯ä¸ª WebSocket è¿æ¥ç‹¬ç«‹ï¼ˆå¦‚èŠå¤©ä¸Šä¸‹æ–‡ï¼‰ã€‚
> - **Custom**ï¼šè‡ªå·±å®šä¹‰ï¼Œæ¯”å¦‚ã€Œæ¯ä¸ªç§Ÿæˆ·ã€ã€Œæ¯ä¸ªäº‹åŠ¡ã€çš„ä½œç”¨åŸŸã€‚

------

### åœ¨Springä¸­ï¼Œåœ¨beanåŠ è½½/é”€æ¯å‰åï¼Œå¦‚æœæƒ³å®ç°æŸäº›é€»è¾‘ï¼Œå¯ä»¥æ€ä¹ˆåš

åœ¨Springæ¡†æ¶ä¸­ï¼Œå¦‚æœä½ å¸Œæœ›åœ¨BeanåŠ è½½ï¼ˆå³å®ä¾‹åŒ–ã€å±æ€§èµ‹å€¼ã€åˆå§‹åŒ–ç­‰è¿‡ç¨‹å®Œæˆåï¼‰æˆ–é”€æ¯å‰åæ‰§è¡ŒæŸäº›é€»è¾‘ï¼Œä½ å¯ä»¥ä½¿ç”¨Springçš„ç”Ÿå‘½å‘¨æœŸå›è°ƒæ¥å£æˆ–æ³¨è§£ã€‚è¿™äº›æ¥å£å’Œæ³¨è§£å…è®¸ä½ å®šä¹‰åœ¨Beanç”Ÿå‘½å‘¨æœŸçš„å…³é”®ç‚¹æ‰§è¡Œçš„ä»£ç ã€‚

> ä½¿ç”¨init-methodå’Œdestroy-method

åœ¨XMLé…ç½®ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡init-methodå’Œdestroy-methodå±æ€§æ¥æŒ‡å®šBeanåˆå§‹åŒ–åå’Œé”€æ¯å‰éœ€è¦è°ƒç”¨çš„æ–¹æ³•ã€‚

```xml
<bean id="myBean" class="com.example.MyBeanClass"  
      init-method="init" destroy-method="destroy"/>
```

ç„¶åï¼Œåœ¨ä½ çš„Beanç±»ä¸­å®ç°è¿™äº›æ–¹æ³•ï¼š

```java
public class MyBeanClass {  
  
    public void init() {  
        // åˆå§‹åŒ–é€»è¾‘  
    }  
  
    public void destroy() {  
        // é”€æ¯é€»è¾‘  
    }  
}
```

> å®ç°InitializingBeanå’ŒDisposableBeanæ¥å£

ä½ çš„Beanç±»å¯ä»¥==å®ç°org.springframework.beans.factory.InitializingBeanå’Œorg.springframework.beans.factory.DisposableBeanæ¥==å£ï¼Œå¹¶åˆ†åˆ«å®ç°==afterPropertiesSetå’Œdestroy==æ–¹æ³•ã€‚

```java
import org.springframework.beans.factory.DisposableBean;  
import org.springframework.beans.factory.InitializingBean;  
  
public class MyBeanClass implements InitializingBean, DisposableBean {  
  
    @Override  
    public void afterPropertiesSet() throws Exception {  
        // åˆå§‹åŒ–é€»è¾‘  
    }  
  
    @Override  
    public void destroy() throws Exception {  
        // é”€æ¯é€»è¾‘  
    }  
}
```

> ä½¿ç”¨@PostConstructå’Œ@PreDestroyæ³¨è§£

```java
import javax.annotation.PostConstruct;  
import javax.annotation.PreDestroy;  
  
public class MyBeanClass {  
  
    @PostConstruct  
    public void init() {  
        // åˆå§‹åŒ–é€»è¾‘  
    }  
  
    @PreDestroy  
    public void destroy() {  
        // é”€æ¯é€»è¾‘  
    }  
}
```

> ä½¿ç”¨@Beanæ³¨è§£çš„initMethodå’ŒdestroyMethodå±æ€§

åœ¨åŸºäºJavaçš„é…ç½®ä¸­ï¼Œä½ è¿˜å¯ä»¥åœ¨@Beanæ³¨è§£ä¸­æŒ‡å®šinitMethodå’ŒdestroyMethodå±æ€§ã€‚

```java
@Configuration  
public class AppConfig {  
  
    @Bean(initMethod = "init", destroyMethod = "destroy")  
    public MyBeanClass myBean() {  
        return new MyBeanClass();  
    }  
}
```

------

### Springç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ‰©å±•ç‚¹ï¼Œè¿™äº›æœ‰äº†è§£å—ï¼Ÿ

Springæ¡†æ¶æä¾›äº†è®¸å¤šæ‰©å±•ç‚¹ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€æ±‚å®šåˆ¶å’Œæ‰©å±•Springçš„åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„æ‰©å±•ç‚¹ï¼š

1. BeanFactoryPostProcessorï¼šå…è®¸åœ¨Springå®¹å™¨å®ä¾‹åŒ–beanä¹‹å‰ä¿®æ”¹beançš„å®šä¹‰ã€‚å¸¸ç”¨äºä¿®æ”¹beanå±æ€§æˆ–æ”¹å˜beançš„ä½œç”¨åŸŸã€‚
2. BeanPostProcessorï¼šå¯ä»¥åœ¨beanå®ä¾‹åŒ–ã€é…ç½®ä»¥åŠåˆå§‹åŒ–ä¹‹åå¯¹å…¶è¿›è¡Œé¢å¤–å¤„ç†ã€‚å¸¸ç”¨äºä»£ç†beanã€ä¿®æ”¹beanå±æ€§ç­‰ã€‚
3. PropertySourceï¼šç”¨äºå®šä¹‰ä¸åŒçš„å±æ€§æºï¼Œå¦‚æ–‡ä»¶ã€æ•°æ®åº“ç­‰ï¼Œä»¥ä¾¿åœ¨Springåº”ç”¨ä¸­ä½¿ç”¨ã€‚
4. ImportSelectorå’ŒImportBeanDefinitionRegistrarï¼šç”¨äºæ ¹æ®æ¡ä»¶åŠ¨æ€æ³¨å†Œbeanå®šä¹‰ï¼Œå®ç°é…ç½®ç±»çš„æ¨¡å—åŒ–ã€‚
5. Spring MVCä¸­çš„HandlerInterceptorï¼šç”¨äºæ‹¦æˆªå¤„ç†è¯·æ±‚ï¼Œå¯ä»¥åœ¨è¯·æ±‚å¤„ç†å‰ã€å¤„ç†ä¸­å’Œå¤„ç†åæ‰§è¡Œç‰¹å®šé€»è¾‘ã€‚
6. Spring MVCä¸­çš„ControllerAdviceï¼šç”¨äºå…¨å±€å¤„ç†æ§åˆ¶å™¨çš„å¼‚å¸¸ã€æ•°æ®ç»‘å®šå’Œæ•°æ®æ ¡éªŒã€‚
7. Spring Bootçš„è‡ªåŠ¨é…ç½®ï¼šé€šè¿‡åˆ›å»ºè‡ªå®šä¹‰çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œå¯ä»¥å®ç°å¯¹æ¡†æ¶å’Œç¬¬ä¸‰æ–¹åº“çš„è‡ªåŠ¨é…ç½®ã€‚
8. è‡ªå®šä¹‰æ³¨è§£ï¼šåˆ›å»ºè‡ªå®šä¹‰æ³¨è§£ï¼Œç”¨äºå®ç°ç‰¹å®šåŠŸèƒ½æˆ–çº¦å®šï¼Œå¦‚æƒé™æ§åˆ¶ã€æ—¥å¿—è®°å½•ç­‰ã€‚

> Spring æ¡†æ¶æä¾›äº†ä¸°å¯Œçš„æ‰©å±•ç‚¹ï¼Œå…è®¸å¼€å‘è€…åœ¨å®¹å™¨çš„ä¸åŒç”Ÿå‘½å‘¨æœŸé˜¶æ®µæ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚ä»¥ä¸‹æ˜¯ **10 ä¸ªæ ¸å¿ƒæ‰©å±•ç‚¹**çš„è¯¦ç»†è¯´æ˜å’Œä»£ç ç¤ºä¾‹ï¼š
>
> ------
>
> ### **1. BeanFactoryPostProcessor**
>
> **ä½œç”¨**ï¼šåœ¨ Bean å®šä¹‰åŠ è½½åã€å®ä¾‹åŒ–å‰ä¿®æ”¹ Bean çš„å®šä¹‰ï¼ˆå¦‚ä¿®æ”¹å±æ€§ã€ä½œç”¨åŸŸï¼‰ã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šåŠ¨æ€ä¿®æ”¹é…ç½®ã€æ›¿æ¢å ä½ç¬¦ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šæ›¿æ¢æ‰€æœ‰ Bean çš„ `scope` ä¸ºåŸå‹æ¨¡å¼
>
> ```
> @Component
> public class CustomBeanFactoryPostProcessor implements BeanFactoryPostProcessor {
>     @Override
>     public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {
>         for (String beanName : beanFactory.getBeanDefinitionNames()) {
>             BeanDefinition definition = beanFactory.getBeanDefinition(beanName);
>             definition.setScope(BeanDefinition.SCOPE_PROTOTYPE); // å¼ºåˆ¶æ”¹ä¸ºåŸå‹
>         }
>     }
> }
> ```
>
> ------
>
> ### **2. BeanPostProcessor**
>
> **ä½œç”¨**ï¼šåœ¨ Bean åˆå§‹åŒ–å‰åæ‰§è¡Œé€»è¾‘ï¼ˆå¦‚ä»£ç†ã€ç›‘æ§ï¼‰ã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šAOP ä»£ç†ã€æ€§èƒ½ç›‘æ§ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šç»Ÿè®¡ Bean åˆå§‹åŒ–è€—æ—¶
>
> ```
> @Component
> public class TimingBeanPostProcessor implements BeanPostProcessor {
>     @Override
>     public Object postProcessBeforeInitialization(Object bean, String beanName) {
>         return bean; // åˆå§‹åŒ–å‰ä¸åšå¤„ç†
>     }
> 
>     @Override
>     public Object postProcessAfterInitialization(Object bean, String beanName) {
>         System.out.println("Bean [" + beanName + "] åˆå§‹åŒ–å®Œæˆ");
>         return bean;
>     }
> }
> ```
>
> ------
>
> ### **3. PropertySource**
>
> **ä½œç”¨**ï¼šè‡ªå®šä¹‰å±æ€§æºï¼ˆå¦‚æ•°æ®åº“ã€è¿œç¨‹é…ç½®ï¼‰ã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šä»æ•°æ®åº“åŠ è½½é…ç½®ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šåŠ¨æ€æ·»åŠ å†…å­˜å±æ€§æº
>
> ```
> @Configuration
> public class CustomPropertySourceConfig {
>     @Bean
>     public static PropertySourcesPlaceholderConfigurer propertySources() {
>         PropertySourcesPlaceholderConfigurer configurer = new PropertySourcesPlaceholderConfigurer();
>         Map<String, Object> customProperties = Map.of("app.version", "1.0.0");
>         configurer.setPropertiesArray(new Properties() {{
>             putAll(customProperties);
>         }});
>         return configurer;
>     }
> }
> ```
>
> ------
>
> ### **4. ImportSelector & ImportBeanDefinitionRegistrar**
>
> **ä½œç”¨**ï¼šåŠ¨æ€æ³¨å†Œ Bean å®šä¹‰ã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šæ¡ä»¶åŒ–åŠ è½½æ¨¡å—ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šæ ¹æ®ç¯å¢ƒå˜é‡é€‰æ‹©é…ç½®ç±»
>
> ```
> public class EnvAwareImportSelector implements ImportSelector {
>     @Override
>     public String[] selectImports(AnnotationMetadata metadata) {
>         String env = System.getProperty("spring.profiles.active", "dev");
>         return env.equals("prod") ? 
>             new String[] { ProdConfig.class.getName() } : 
>             new String[] { DevConfig.class.getName() };
>     }
> }
> 
> // ä½¿ç”¨ï¼š@Import(EnvAwareImportSelector.class)
> ```
>
> ------
>
> ### **5. HandlerInterceptor (Spring MVC)**
>
> **ä½œç”¨**ï¼šæ‹¦æˆª HTTP è¯·æ±‚ã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šæƒé™æ ¡éªŒã€æ—¥å¿—è®°å½•ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šè®°å½•è¯·æ±‚è€—æ—¶
>
> ```
> public class TimingInterceptor implements HandlerInterceptor {
>     @Override
>     public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
>         request.setAttribute("startTime", System.currentTimeMillis());
>         return true;
>     }
> 
>     @Override
>     public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
>         long duration = System.currentTimeMillis() - (long) request.getAttribute("startTime");
>         System.out.println("è¯·æ±‚è€—æ—¶: " + duration + "ms");
>     }
> }
> 
> // æ³¨å†Œï¼šWebMvcConfigurer.addInterceptors()
> ```
>
> ------
>
> ### **6. @ControllerAdvice (Spring MVC)**
>
> **ä½œç”¨**ï¼šå…¨å±€å¤„ç†æ§åˆ¶å™¨å¼‚å¸¸/æ•°æ®ç»‘å®šã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šæ•è·æ‰€æœ‰æ§åˆ¶å™¨å¼‚å¸¸
>
> ```
> @ControllerAdvice
> public class GlobalExceptionHandler {
>     @ExceptionHandler(Exception.class)
>     public ResponseEntity<String> handleException(Exception e) {
>         return ResponseEntity.status(500).body("é”™è¯¯: " + e.getMessage());
>     }
> }
> ```
>
> ------
>
> ### **7. Spring Boot è‡ªåŠ¨é…ç½®**
>
> **ä½œç”¨**ï¼šåŸºäºæ¡ä»¶è‡ªåŠ¨é…ç½® Beanã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šå¼€å‘ Starter åº“ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šå½“ç±»è·¯å¾„å­˜åœ¨ `DataSource` æ—¶è‡ªåŠ¨é…ç½®è¿æ¥æ± 
>
> ```
> @Configuration
> @ConditionalOnClass(DataSource.class)
> public class DataSourceAutoConfig {
>     @Bean
>     @ConditionalOnMissingBean
>     public DataSource dataSource() {
>         return new HikariDataSource();
>     }
> }
> ```
>
> ------
>
> ### **8. è‡ªå®šä¹‰æ³¨è§£**
>
> **ä½œç”¨**ï¼šé€šè¿‡æ³¨è§£é©±åŠ¨è¡Œä¸ºã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šæƒé™æ§åˆ¶ã€æ—¥å¿—åˆ‡é¢ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šè®°å½•æ–¹æ³•æ‰§è¡Œæ—¥å¿—
>
> ```
> @Retention(RetentionPolicy.RUNTIME)
> @Target(ElementType.METHOD)
> public @interface LogExecution {}
> 
> @Aspect
> @Component
> public class LogAspect {
>     @Around("@annotation(LogExecution)")
>     public Object log(ProceedingJoinPoint pjp) throws Throwable {
>         System.out.println("å¼€å§‹æ‰§è¡Œ: " + pjp.getSignature());
>         Object result = pjp.proceed();
>         System.out.println("æ‰§è¡Œå®Œæˆ");
>         return result;
>     }
> }
> ```
>
> ------
>
> ### **9. ApplicationListener**
>
> **ä½œç”¨**ï¼šç›‘å¬ Spring äº‹ä»¶ï¼ˆå¦‚å®¹å™¨åˆ·æ–°ã€Bean åˆ›å»ºï¼‰ã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šå¯åŠ¨æ—¶åˆå§‹åŒ–ç¼“å­˜ã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šå®¹å™¨å¯åŠ¨ååŠ è½½æ•°æ®
>
> ```
> @Component
> public class CacheInitializer implements ApplicationListener<ContextRefreshedEvent> {
>     @Override
>     public void onApplicationEvent(ContextRefreshedEvent event) {
>         System.out.println("å®¹å™¨å·²åˆ·æ–°ï¼Œåˆå§‹åŒ–ç¼“å­˜...");
>     }
> }
> ```
>
> ------
>
> ### **10. SmartInitializingSingleton**
>
> **ä½œç”¨**ï¼šæ‰€æœ‰å•ä¾‹ Bean åˆå§‹åŒ–å®Œæˆåæ‰§è¡Œã€‚
>  â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹ï¼šä¾èµ–æ£€æŸ¥ã€å¯åŠ¨åæ“ä½œã€‚
>  â€‹**â€‹ç¤ºä¾‹â€‹**â€‹ï¼šéªŒè¯æ‰€æœ‰ Service æ˜¯å¦æ³¨å…¥æˆåŠŸ
>
> ```
> @Component
> public class DependencyChecker implements SmartInitializingSingleton {
>     @Autowired
>     private List<MyService> services; // æ”¶é›†æ‰€æœ‰MyService
> 
>     @Override
>     public void afterSingletonsInstantiated() {
>         if (services.isEmpty()) {
>             throw new IllegalStateException("æœªæ‰¾åˆ°ä»»ä½•MyServiceå®ç°ï¼");
>         }
>     }
> }
> ```
>
> ------
>
> ### **æ‰©å±•ç‚¹å¯¹æ¯”æ€»ç»“**
>
> | **æ‰©å±•ç‚¹**                   | **è§¦å‘æ—¶æœº**               | **å…¸å‹åº”ç”¨**           |
> | ---------------------------- | -------------------------- | ---------------------- |
> | `BeanFactoryPostProcessor`   | Bean å®šä¹‰åŠ è½½å            | åŠ¨æ€ä¿®æ”¹ Bean é…ç½®     |
> | `BeanPostProcessor`          | Bean åˆå§‹åŒ–å‰å            | AOP ä»£ç†ã€ç›‘æ§         |
> | `PropertySource`             | ç¯å¢ƒå‡†å¤‡é˜¶æ®µ               | è‡ªå®šä¹‰é…ç½®æº           |
> | `ImportSelector`             | é…ç½®ç±»åŠ è½½æ—¶               | æ¡ä»¶åŒ–æ¨¡å—å¯¼å…¥         |
> | `HandlerInterceptor`         | HTTP è¯·æ±‚å¤„ç†å‰å          | æƒé™æ§åˆ¶ã€æ—¥å¿—è®°å½•     |
> | `@ControllerAdvice`          | æ§åˆ¶å™¨æ–¹æ³•æ‰§è¡Œå           | å…¨å±€å¼‚å¸¸å¤„ç†           |
> | `@Conditional`               | è‡ªåŠ¨é…ç½®æ¡ä»¶åˆ¤æ–­           | Starter åº“å¼€å‘         |
> | è‡ªå®šä¹‰æ³¨è§£ + AOP             | æ–¹æ³•è°ƒç”¨æ—¶                 | å£°æ˜å¼äº‹åŠ¡ã€æ—¥å¿—       |
> | `ApplicationListener`        | ç‰¹å®šäº‹ä»¶å‘å¸ƒæ—¶             | å¯åŠ¨ä»»åŠ¡ã€äº‹ä»¶å“åº”     |
> | `SmartInitializingSingleton` | æ‰€æœ‰å•ä¾‹ Bean åˆå§‹åŒ–å®Œæˆå | ä¾èµ–æ£€æŸ¥ã€å¯åŠ¨ååˆå§‹åŒ– |

## SpringMVC

### 
